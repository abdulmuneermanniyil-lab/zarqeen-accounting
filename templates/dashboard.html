<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zarqeen Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563EB; --primary-hover: #1D4ED8;
            --danger: #EF4444; --danger-hover: #DC2626;
            --success: #10B981; --gray: #6B7280; --bg: #F3F4F6;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 20px; color: #1F2937; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Cards & Layout */
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #E5E7EB; }
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; color: #111827; }
        h2 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 800px; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #E5E7EB; }
        th { background: #F9FAFB; font-weight: 600; color: #4B5563; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: #F9FAFB; }
        
        /* Buttons */
        .btn { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; color: white; font-weight: 500; font-size: 0.85rem; transition: 0.2s; text-decoration: none; display: inline-block; }
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; }
        .btn-red { background: var(--danger); } .btn-red:hover { background: var(--danger-hover); }
        .btn-green { background: var(--success); } .btn-green:hover { background: #059669; }
        .btn-blue { background: var(--primary); } .btn-blue:hover { background: var(--primary-hover); }
        .btn-gray { background: #9CA3AF; } .btn-gray:hover { background: #6B7280; }
        
        /* Forms */
        input, select { width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px; box-sizing: border-box; transition: 0.2s; font-size: 0.9rem; }
        input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        label { display: block; font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        /* Badges */
        .badge { padding: 2px 8px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        .bg-green-light { background: #D1FAE5; color: #065F46; }
        .bg-gray-light { background: #F3F4F6; color: #4B5563; }
        .balance-neg { color: #DC2626; font-weight: 700; }
        .balance-pos { color: #059669; font-weight: 700; }

        /* --- NEW MODAL STYLES --- */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); animation: fadeIn 0.2s; }
        .modal-content { background-color: white; margin: 5vh auto; padding: 0; border-radius: 16px; width: 95%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); position: relative; }
        .modal-header { padding: 20px 30px; border-bottom: 1px solid #E5E7EB; background: #F9FAFB; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; color: #111827; font-size: 1.25rem; }
        .modal-close { cursor: pointer; font-size: 1.5rem; color: #9CA3AF; line-height: 1; }
        .modal-body { padding: 30px; }
        
        .form-section { margin-bottom: 25px; }
        .form-section-title { font-size: 0.95rem; font-weight: 700; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 15px; border-bottom: 2px solid #F3F4F6; padding-bottom: 5px; }
        
        .pay-box { background: #F0FDF4; border: 1px solid #BBF7D0; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .pay-box-label { color: #047857; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        
        .correct-box { background: #FEF2F2; border: 1px solid #FECACA; padding: 15px; border-radius: 8px; }
        .correct-box label { color: #991B1B; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        
        <!-- TOP NAV -->
        <div class="header-row">
            <h1>Admin Dashboard</h1>
            <a href="/admin/logout" class="btn btn-red">Logout</a>
        </div>

        <!-- MESSAGES -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div style="padding:15px; margin-bottom:20px; border-radius:8px; border:1px solid transparent;
                        background: {{ '#ECFDF5' if category == 'success' else '#FEF2F2' }}; 
                        color: {{ '#065F46' if category == 'success' else '#991B1B' }};
                        border-color: {{ '#A7F3D0' if category == 'success' else '#FECACA' }};">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- 1. DISTRIBUTORS -->
        <div class="card">
            <div class="header-row">
                <h2>üë• Distributors</h2>
                <a href="/admin/export/distributors" class="btn btn-gray btn-sm">‚¨á Export CSV</a>
            </div>
            
            <details style="margin-bottom: 20px; border: 1px solid #E5E7EB; padding: 15px; border-radius: 8px;">
                <summary style="cursor:pointer; font-weight:600; color:var(--primary);">+ Click to Add New Distributor</summary>
                <form action="/admin/add_distributor" method="POST" class="grid-form" style="margin-top:20px;">
                    <div><label>Business Name</label><input type="text" name="name" required></div>
                    <div><label>Email</label><input type="email" name="email" required></div>
                    <div><label>Phone</label><input type="text" name="phone" required></div>
                    <div><label>Code (4 Chars)</label><input type="text" name="code" maxlength="4" style="text-transform:uppercase" required></div>
                    <div><label>Password</label><input type="password" name="password" required></div>
                    <div><label>Discount %</label><input type="number" name="discount" value="10"></div>
                    <div><label>Bank Name</label><input type="text" name="bank_name"></div>
                    <div><label>Acct Holder</label><input type="text" name="account_holder"></div>
                    <div><label>Acct No</label><input type="text" name="account_number"></div>
                    <div><label>IFSC</label><input type="text" name="ifsc_code"></div>
                    <div><label>UPI</label><input type="text" name="upi_id"></div>
                    <div style="display:flex; align-items:end;"><button type="submit" class="btn btn-green" style="width:100%">Create Account</button></div>
                </form>
            </details>

            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Name / Email</th><th>Code</th><th>Financials</th><th>Banking</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        {% for d in distributors %}
                        <tr>
                            <td>
                                <b>{{ d.obj.name }}</b><br>
                                <span style="font-size:0.8rem; color:#6B7280;">{{ d.obj.email }}</span>
                            </td>
                            <td>
                                <span style="font-family:monospace; font-weight:bold; font-size:1rem;">{{ d.obj.code }}</span><br>
                                <span class="badge bg-gray-light">Disc: {{d.obj.discount_percent}}%</span>
                            </td>
                            <td style="font-size:0.85rem; line-height:1.4;">
                                Earned: ‚Çπ{{ "%.2f"|format(d.earned) }}<br>
                                Paid: <span style="color:#059669">‚Çπ{{ "%.2f"|format(d.obj.commission_paid) }}</span><br>
                                Bal: <span class="{{ 'balance-neg' if d.balance > 0 else 'balance-pos' }}">‚Çπ{{ "%.2f"|format(d.balance) }}</span>
                            </td>
                            <td style="font-size:0.8rem; color:#4B5563;">
                                {% if d.obj.bank_name %}{{ d.obj.bank_name }} - {{ d.obj.account_number }}<br>{% endif %}
                                {% if d.obj.upi_id %}UPI: {{ d.obj.upi_id }}{% endif %}
                                {% if not d.obj.bank_name and not d.obj.upi_id %}-{% endif %}
                            </td>
                            <td>
                                <button class="btn btn-blue btn-sm" onclick="openEdit('{{d.obj.id}}', '{{d.obj.name}}', '{{d.obj.email}}', '{{d.obj.phone}}', '{{d.obj.discount_percent}}', '{{d.obj.bank_name}}', '{{d.obj.account_holder}}', '{{d.obj.account_number}}', '{{d.obj.ifsc_code}}', '{{d.obj.upi_id}}', '{{d.obj.commission_paid}}')">Edit / Pay</button>
                                <form action="{{ url_for('delete_distributor', id=d.obj.id) }}" method="POST" style="display:inline" onsubmit="return confirm('Are you sure? This will detach all associated licenses.');">
                                    <button class="btn btn-red btn-sm">Del</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="5" style="text-align:center; padding:20px;">No distributors found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 2. LICENSES -->
        <div class="card">
            <div class="header-row">
                <h2>üìÇ License History</h2>
                <a href="/admin/export/licenses" class="btn btn-gray btn-sm">‚¨á Export CSV</a>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>License Key</th>
                            <th>Plan</th>
                            <th>Distributor</th>
                            <th>Amount</th>
                            <th>Used At</th> <!-- NEW COLUMN -->
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for lic in licenses %}
                        <tr>
                            <td>{{ lic.created_at.strftime('%Y-%m-%d') }}</td>
                            <td style="font-family:monospace; font-weight:600; color:#2563EB;">{{ lic.license_key }}</td>
                            <td>{{ lic.plan_type|upper }}</td>
                            <td>{{ lic.distributor.name if lic.distributor else 'Direct' }}</td>
                            <td>‚Çπ{{ lic.amount_paid }}</td>
                            
                            <!-- NEW USED AT COLUMN -->
                            <td style="font-size:0.85rem; color:#4B5563;">
                                {{ lic.used_at.strftime('%Y-%m-%d') if lic.used_at else '-' }}
                            </td>
                            
                            <td>
                                <span class="badge {{ 'bg-green-light' if lic.is_used else 'bg-gray-light' }}">
                                    {{ 'USED' if lic.is_used else 'ACTIVE' }}
                                </span>
                            </td>
                            <td style="display:flex; gap:5px;">
                                <a href="/download/license/{{ lic.license_key }}" class="btn btn-green btn-sm" title="Download">‚¨á</a>
                                <form action="{{ url_for('edit_license', id=lic.id) }}" method="POST">
                                    <input type="hidden" name="status" value="{{ 'active' if lic.is_used else 'used' }}">
                                    <button class="btn btn-blue btn-sm" title="Toggle Status">Toggle</button>
                                </form>
                                <form action="{{ url_for('delete_license', id=lic.id) }}" method="POST" onsubmit="return confirm('Delete?');">
                                    <button class="btn btn-red btn-sm">X</button>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="8" style="text-align:center; padding:20px;">No licenses found.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- IMPROVED EDIT MODAL -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Distributor Details</h3>
                <span class="modal-close" onclick="document.getElementById('editModal').style.display='none'">&times;</span>
            </div>
            
            <form id="editForm" method="POST" class="modal-body">
                
                <!-- Section 1 -->
                <div class="form-section">
                    <div class="form-section-title">Profile & Login</div>
                    <div class="grid-form">
                        <div><label>Name</label><input type="text" name="name" id="e_name" required></div>
                        <div><label>Email</label><input type="email" name="email" id="e_email" required></div>
                        <div><label>Phone</label><input type="text" name="phone" id="e_phone"></div>
                        <div><label>Discount %</label><input type="number" name="discount" id="e_disc" required></div>
                        <div><label>New Password</label><input type="password" name="password" placeholder="(Leave blank to keep)"></div>
                    </div>
                </div>

                <!-- Section 2 -->
                <div class="form-section">
                    <div class="form-section-title">Banking Information</div>
                    <div class="grid-form">
                        <div><label>Bank Name</label><input type="text" name="bank_name" id="e_bank_name"></div>
                        <div><label>Account Holder</label><input type="text" name="account_holder" id="e_acct_holder"></div>
                        <div><label>Account No</label><input type="text" name="account_number" id="e_acct_no"></div>
                        <div><label>IFSC Code</label><input type="text" name="ifsc_code" id="e_ifsc"></div>
                        <div><label>UPI ID</label><input type="text" name="upi_id" id="e_upi"></div>
                    </div>
                </div>

                <!-- Section 3: Payments -->
                <div class="form-section">
                    <div class="form-section-title">Commission & Payments</div>
                    
                    <div class="pay-box">
                        <div class="pay-box-label">üí∞ Make a Payment</div>
                        <input type="number" step="0.01" name="add_payment" placeholder="Enter amount to pay (e.g., 500)">
                        <div style="font-size:0.8rem; color:#065F46; margin-top:5px;">This will add to the 'Total Paid' amount.</div>
                    </div>

                    <div class="correct-box">
                        <label>‚ö†Ô∏è Correction (Override Total Paid)</label>
                        <input type="number" step="0.01" name="manual_paid_total" id="e_paid_total">
                    </div>
                </div>

                <div style="text-align:right; margin-top:20px;">
                    <button type="button" class="btn btn-gray" onclick="document.getElementById('editModal').style.display='none'" style="margin-right:10px;">Cancel</button>
                    <button type="submit" class="btn btn-blue" style="padding:10px 25px; font-size:1rem;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        function openEdit(id, name, email, phone, disc, bName, bHolder, bNo, ifsc, upi, currentPaid) {
            const form = document.getElementById('editForm');
            form.action = `/admin/edit_distributor/${id}`;
            
            // Fill Profile
            document.getElementById('e_name').value = name;
            document.getElementById('e_email').value = email;
            document.getElementById('e_phone').value = phone;
            document.getElementById('e_disc').value = disc;
            
            // Fill Bank (handle None/null)
            document.getElementById('e_bank_name').value = (bName && bName !== 'None') ? bName : '';
            document.getElementById('e_acct_holder').value = (bHolder && bHolder !== 'None') ? bHolder : '';
            document.getElementById('e_acct_no').value = (bNo && bNo !== 'None') ? bNo : '';
            document.getElementById('e_ifsc').value = (ifsc && ifsc !== 'None') ? ifsc : '';
            document.getElementById('e_upi').value = (upi && upi !== 'None') ? upi : '';
            
            // Payments
            document.getElementById('e_paid_total').placeholder = `Current Paid: ‚Çπ${currentPaid}`;
            document.getElementsByName('add_payment')[0].value = '';
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        window.onclick = function(e) {
            if (e.target == document.getElementById('editModal')) {
                document.getElementById('editModal').style.display = 'none';
            }
        }
    </script>
</body>
</html>
