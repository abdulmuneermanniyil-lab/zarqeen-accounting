<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Zarqeen Admin Dashboard</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f3f4f6; color: #1f2937; }
        
        /* Header Area */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex-wrap: wrap; gap: 10px; }
        h1 { margin: 0; font-size: 1.5rem; color: #4F46E5; }
        
        /* Controls */
        .controls { display: flex; gap: 10px; align-items: center; }
        .search-input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; width: 250px; font-size: 0.9rem; }

        /* Buttons */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 4px; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }

        .btn-logout { background: #dc2626; color: white; padding: 8px 16px; }
        .btn-excel { background: #10B981; color: white; padding: 8px 16px; }
        
        /* Action Buttons */
        .btn-download { background: #8B5CF6; color: white; margin-right: 4px; } /* Purple for Download */
        .btn-edit { background: #3b82f6; color: white; margin-right: 4px; }    /* Blue for Edit */
        .btn-delete { background: #ef4444; color: white; }                        /* Red for Delete */
        
        /* Table */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        
        th { 
            background-color: #f9fafb; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; color: #6b7280; 
            cursor: pointer; user-select: none; 
        }
        th:hover { background-color: #e5e7eb; color: #111827; }

        th.sort-asc::after { content: " â–²"; font-size: 0.7rem; color: #4F46E5; }
        th.sort-desc::after { content: " â–¼"; font-size: 0.7rem; color: #4F46E5; }
        
        tr:hover { background-color: #f9fafb; }
        
        /* Status Badges */
        .status { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
        .status-used { background: #fee2e2; color: #991b1b; }
        .status-new { background: #d1fae5; color: #065f46; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 25px; border-radius: 8px; width: 400px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #6b7280; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; }
        .btn-save { width: 100%; background: #4F46E5; color: white; margin-top: 10px; padding: 10px; }
        
        .alert { padding: 10px; margin-bottom: 20px; border-radius: 4px; background: #d1fae5; color: #065f46; text-align: center; }
        .alert.danger { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="header">
        <h1>License Database</h1>
        
        <div class="controls">
            <input type="text" id="searchInput" onkeyup="filterTable()" class="search-input" placeholder="ðŸ” Search keys, names, IDs...">
            <button onclick="downloadExcel()" class="btn btn-excel">ðŸ“¥ Export Excel</button>
            <a href="/admin/logout" class="btn btn-logout">Logout</a>
        </div>
    </div>

    <!-- Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert {{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Table -->
    <div class="table-container">
        <table id="licenseTable">
            <thead>
                <tr>
                    <th onclick="sortTable(0)">ID</th>
                    <th onclick="sortTable(1)">License Key</th>
                    <th onclick="sortTable(2)">Plan</th>
                    <th onclick="sortTable(3)">Payment ID</th>
                    <th onclick="sortTable(4)">Status</th>
                    <th onclick="sortTable(5)">Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for lic in licenses %}
                <tr>
                    <td>{{ lic.id }}</td>
                    <td style="font-family: monospace;">{{ lic.license_key }}</td>
                    <td>{{ lic.plan_type.upper() }}</td>
                    <td>{{ lic.payment_id }}</td>
                    <td>
                        {% if lic.is_used %}
                            <span class="status status-used">USED</span>
                        {% else %}
                            <span class="status status-new">ACTIVE</span>
                        {% endif %}
                    </td>
                    <td>{{ lic.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <!-- 1. DOWNLOAD BUTTON (New) -->
                        <button class="btn btn-download" title="Download File" 
                            onclick="downloadSingleFile('{{ lic.license_key }}')">
                            â¬‡
                        </button>

                        <!-- 2. EDIT BUTTON -->
                        <button class="btn btn-edit" title="Edit"
                            onclick="openEditModal('{{ lic.id }}', '{{ lic.license_key }}', '{{ lic.plan_type }}', '{{ lic.payment_id }}', '{{ lic.is_used }}')">
                            âœŽ
                        </button>

                        <!-- 3. DELETE BUTTON -->
                        <form action="/admin/delete_license/{{ lic.id }}" method="POST" style="display:inline;" onsubmit="return confirm('Delete this license?');">
                            <button type="submit" class="btn btn-delete" title="Delete">âœ–</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
            <h2 style="margin-top:0; margin-bottom: 20px;">Edit License</h2>
            
            <form id="editForm" method="POST">
                <div class="form-group">
                    <label>License Key</label>
                    <input type="text" name="license_key" id="editKey" required>
                </div>
                <div class="form-group">
                    <label>Plan Type</label>
                    <select name="plan_type" id="editPlan">
                        <option value="basic">basic</option>
                        <option value="premium">premium</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment ID</label>
                    <input type="text" name="payment_id" id="editPaymentId" required>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="is_used" id="editIsUsed" style="width: auto;">
                    <label for="editIsUsed" style="margin: 0; cursor: pointer;">Mark as Used</label>
                </div>
                <button type="submit" class="btn btn-save">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // --- NEW: DOWNLOAD SINGLE FILE FUNCTION ---
        function downloadSingleFile(keyString) {
            // Clean the key string just in case
            const cleanKey = keyString.trim();
            
            // Create a blob (file-like object)
            const blob = new Blob([cleanKey], { type: "text/plain" });
            const url = window.URL.createObjectURL(blob);
            
            // Create invisible link and click it
            const a = document.createElement("a");
            a.href = url;
            a.download = "license.zarqeen"; // Standard filename
            document.body.appendChild(a);
            a.click();
            
            // Cleanup
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // --- SEARCH FUNCTION ---
        function filterTable() {
            let input = document.getElementById("searchInput");
            let filter = input.value.toUpperCase();
            let table = document.getElementById("licenseTable");
            let tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) {
                let showRow = false;
                let tds = tr[i].getElementsByTagName("td");
                for(let j = 0; j < tds.length - 1; j++) {
                    if (tds[j]) {
                        let txtValue = tds[j].textContent || tds[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            showRow = true;
                            break;
                        }
                    }
                }
                tr[i].style.display = showRow ? "" : "none";
            }
        }

        // --- SORT FUNCTION ---
        function sortTable(n) {
            var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            table = document.getElementById("licenseTable");
            switching = true;
            dir = "asc"; 
            
            var headers = table.getElementsByTagName("th");
            for (var h = 0; h < headers.length; h++) {
                headers[h].classList.remove("sort-asc", "sort-desc");
            }

            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    
                    var xContent = x.innerHTML.toLowerCase();
                    var yContent = y.innerHTML.toLowerCase();
                    var isNum = !isNaN(parseFloat(xContent)) && isFinite(xContent) && !isNaN(parseFloat(yContent)) && isFinite(yContent);

                    if (dir == "asc") {
                        if (isNum) {
                            if (parseFloat(xContent) > parseFloat(yContent)) { shouldSwitch = true; break; }
                        } else {
                            if (xContent > yContent) { shouldSwitch = true; break; }
                        }
                    } else if (dir == "desc") {
                        if (isNum) {
                            if (parseFloat(xContent) < parseFloat(yContent)) { shouldSwitch = true; break; }
                        } else {
                            if (xContent < yContent) { shouldSwitch = true; break; }
                        }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount ++;
                } else {
                    if (switchcount == 0 && dir == "asc") {
                        dir = "desc";
                        switching = true;
                    }
                }
            }
            headers[n].classList.add(dir == "asc" ? "sort-asc" : "sort-desc");
        }

        // --- EXPORT EXCEL ---
        function downloadExcel() {
            let table = document.getElementById("licenseTable");
            let rows = Array.from(table.rows);
            let csvContent = "";

            rows.forEach(function(row) {
                if (row.style.display === 'none') return;
                let rowData = [];
                let cols = Array.from(row.querySelectorAll("td, th"));
                cols.slice(0, -1).forEach(function(col) {
                    let text = col.innerText.replace(/(\r\n|\n|\r)/gm, "").trim();
                    rowData.push('"' + text + '"');
                });
                csvContent += rowData.join(",") + "\r\n";
            });

            let blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            let link = document.createElement("a");
            let url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "Zarqeen_Licenses.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- MODAL LOGIC ---
        function openEditModal(id, key, plan, paymentId, isUsed) {
            document.getElementById('editForm').action = "/admin/edit_license/" + id;
            document.getElementById('editKey').value = key;
            document.getElementById('editPlan').value = plan;
            document.getElementById('editPaymentId').value = paymentId;
            document.getElementById('editIsUsed').checked = (isUsed === 'True');
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('editModal')) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
