<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        :root { --primary: #111827; --accent: #2563EB; --bg: #F3F4F6; --white: #fff; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; background: var(--primary); font-size: 0.9rem; }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
        .btn-red { background: #DC2626; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-red { background: #FEE2E2; color: #991B1B; }
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { padding: 10px 20px; background: #ddd; cursor: pointer; border-radius: 4px; }
        .tab.active { background: var(--primary); color: white; }
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Zarqeen Admin</h1>
        <div>
            <a href="/admin/export/licenses" class="btn">Export Sales</a>
            <a href="/admin/export/distributors" class="btn">Export Distributors</a>
            <a href="/admin/logout" class="btn btn-red">Logout</a>
        </div>
    </div>

    <!-- Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div class="card"><h3>Total Licenses</h3><p style="font-size: 2rem; font-weight: bold;">{{ licenses|length }}</p></div>
        <div class="card"><h3>Distributors</h3><p style="font-size: 2rem; font-weight: bold;">{{ distributors|length }}</p></div>
        <div class="card">
            <h3>Global Settings</h3>
            <form action="/admin/update_settings" method="POST" style="margin-top: 10px;">
                <div class="form-row">
                    <div><label>Bonus Commission %</label><input type="number" name="bonus" value="{{ settings.special_bonus_percent }}"></div>
                    <button type="submit" class="btn">Update</button>
                </div>
            </form>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('distributors')">Distributors</div>
        <div class="tab" onclick="showTab('licenses')">Licenses</div>
    </div>

    <!-- Distributors Section -->
    <div id="distributors" class="section active">
        <div class="card">
            <h3>Add New Distributor</h3>
            <form action="/admin/add_distributor" method="POST" class="form-row">
                <input type="text" name="name" placeholder="Name" required>
                <input type="text" name="code" placeholder="Code (e.g. ALIF)" required>
                <input type="email" name="email" placeholder="Email" required>
                <input type="text" name="phone" placeholder="Phone" required>
                <input type="number" name="discount" placeholder="Discount %" value="10" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn">Add</button>
            </form>
        </div>

        <div class="card">
            <h3>Distributor List</h3>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Code</th>
                        <th>Level</th>
                        <th>Earned</th>
                        <th>Paid</th>
                        <th>Balance</th>
                        <th>Bank Details</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    {% for d in distributors %}
    <tr>
        <form action="/admin/edit_distributor/{{ d.obj.id }}" method="POST">
            <!-- Name & Email Input -->
            <td>
                <input type="text" name="name" value="{{ d.obj.name }}" style="width:100%; margin-bottom:5px; font-weight:bold;">
                <input type="email" name="email" value="{{ d.obj.email }}" style="width:100%; font-size:0.85rem;">
            </td>
            
            <!-- Code (Read Only) & Phone Input -->
            <td>
                <strong style="color:#2563EB;">{{ d.obj.code }}</strong>
                <br>
                <input type="text" name="phone" value="{{ d.obj.phone }}" placeholder="Phone" style="width:100px; margin-top:5px; font-size:0.8rem;">
            </td>
            
            <!-- Level & Discount Input -->
            <td>
                <span class="badge">{{ d.level_name }}</span>
                <div style="margin-top:5px; display:flex; align-items:center; gap:5px;">
                    <small>Disc%</small>
                    <input type="number" name="discount" value="{{ d.obj.discount_percent }}" style="width:50px;">
                </div>
            </td>
            
            <!-- Financials -->
            <td>₹{{ d.earned }}</td>
            <td>
                <input type="number" step="0.01" name="manual_paid_total" value="{{ d.obj.commission_paid }}" style="width: 80px;">
            </td>
            <td style="color: {{ 'red' if d.balance > 0 else 'green' }}">₹{{ d.balance }}</td>
            
            <!-- Bank Info (Hover to see, or keep simple) -->
            <td style="font-size: 0.8rem;">
                <input type="text" name="upi_id" value="{{ d.obj.upi_id or '' }}" placeholder="UPI ID" style="width:100%;">
            </td>
            
            <!-- Actions -->
            <!-- Replace the existing Status and Action columns with this combined logic -->
<td>
    {% if l.is_used %}
        <span class="badge badge-green">INSTALLED</span>
    {% else %}
        <span class="badge badge-red">PENDING</span>
    {% endif %}
</td>
<td>{{ l.software_version }}</td>
<td>{{ l.expiry_date.strftime('%Y-%m-%d') if l.expiry_date else '-' }}</td>
<td>
    <div style="display: flex; gap: 5px; align-items: center;">
        <form action="/admin/edit_license/{{ l.id }}" method="POST" style="display:inline-flex; gap:4px;">
            <select name="status" style="padding: 4px; border-radius: 4px; font-size: 0.8rem;">
                <option value="pending" {{ 'selected' if not l.is_used }}>Set Pending</option>
                <option value="used" {{ 'selected' if l.is_used }}>Set Installed</option>
            </select>
            <button type="submit" class="btn btn-sm">Update</button>
        </form>
        
        <form action="/admin/delete_license/{{ l.id }}" method="POST" style="display:inline;" onsubmit="return confirm('Delete?');">
            <button type="submit" class="btn btn-sm btn-red">X</button>
        </form>
    </div>
</td>
    </tr>
    {% endfor %}
</tbody>
            </table>
        </div>
    </div>

    <!-- Licenses Section -->
    <div id="licenses" class="section">
        <div class="card">
            <h3>Recent Licenses</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Key</th>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Distributor</th>
                        <th>Status</th>
                        <th>Version</th>
                        <th>Expiry</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
    {% for l in licenses %}
    <tr>
        <td>{{ l.created_at.strftime('%Y-%m-%d') }}</td>
        <td style="font-family: monospace;">{{ l.license_key }}</td>
        <td>{{ l.plan_type }}</td>
        <td>₹{{ l.amount_paid }}</td>
        <td>{{ l.distributor.name if l.distributor else 'Direct' }}</td>
        <td>
            {% if l.is_used %}
                <span class="badge badge-green">INSTALLED</span>
            {% else %}
                <span class="badge badge-red">PENDING</span>
            {% endif %}
        </td>
        <td>{{ l.software_version or '-' }}</td>
        <td>{{ l.expiry_date.strftime('%Y-%m-%d') if l.expiry_date else '-' }}</td>
        <td>
            <div style="display: flex; gap: 5px;">
                <form action="/admin/edit_license/{{ l.id }}" method="POST" style="display:flex; gap:2px;">
                    <select name="status" style="font-size:0.7rem;">
                        <option value="pending" {{ 'selected' if not l.is_used }}>Pending</option>
                        <option value="used" {{ 'selected' if l.is_used }}>Installed</option>
                    </select>
                    <button type="submit" class="btn btn-sm">OK</button>
                </form>
                <form action="/admin/delete_license/{{ l.id }}" method="POST" onsubmit="return confirm('Delete?');">
                    <button type="submit" class="btn btn-sm btn-red">X</button>
                </form>
            </div>
        </td>
    </tr>
    {% endfor %}
</tbody>
            </table>
        </div>
    </div>

    <script>
        function showTab(id) {
            document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
