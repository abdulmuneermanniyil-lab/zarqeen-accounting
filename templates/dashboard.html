<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        :root { --primary: #111827; --accent: #2563EB; --bg: #F3F4F6; --white: #fff; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; background: var(--primary); font-size: 0.9rem; }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
        .btn-red { background: #DC2626; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-red { background: #FEE2E2; color: #991B1B; }
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { padding: 10px 20px; background: #ddd; cursor: pointer; border-radius: 4px; }
        .tab.active { background: var(--primary); color: white; }
        .section { display: none; }
        .section.active { display: block; }
        /* Ensure inputs in the table are neat */
.td input {
    padding: 4px 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.85rem;
}
.td input:focus {
    border-color: var(--accent);
    outline: none;
}
    </style>
</head>
<body>
    <div class="header">
        <h1>Zarqeen Admin</h1>
        <div>
            <a href="/admin/export/licenses" class="btn">Export Sales</a>
            <a href="/admin/export/distributors" class="btn">Export Distributors</a>
            <a href="/admin/logout" class="btn btn-red">Logout</a>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div class="card"><h3>Total Licenses</h3><p style="font-size: 2rem; font-weight: bold;">{{ licenses|length }}</p></div>
        <div class="card"><h3>Distributors</h3><p style="font-size: 2rem; font-weight: bold;">{{ distributors|length }}</p></div>
        <div class="card">
    <h3>Global Settings & Bonus</h3>
    <form action="/admin/update_settings" method="POST" style="margin-top: 10px;">
        <div class="form-row" style="flex-direction: column; align-items: stretch; gap: 10px;">
            <div>
                <label style="font-size: 0.8rem;">Bonus Event Name (Visible to Partners)</label>
                <!-- name must be 'bonus_name' to match backend -->
                <input type="text" name="bonus_name" value="{{ settings.special_message }}" placeholder="e.g. Happy New Year 2026" style="width: 100%;">
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label style="font-size: 0.8rem;">Extra Commission %</label>
                    <!-- name must be 'bonus' to match backend -->
                    <input type="number" name="bonus" value="{{ settings.special_bonus_percent }}" placeholder="0" style="width: 100%;">
                </div>
                <button type="submit" class="btn">Update</button>
            </div>
        </div>
    </form>
</div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('distributors')">Distributors</div>
        <div class="tab" onclick="showTab('licenses')">Licenses</div>
    </div>

    <!-- Distributors Section -->
    <div id="distributors" class="section active">
        <div class="card">
            <h3>Add New Distributor</h3>
            <form action="/admin/add_distributor" method="POST" class="form-row">
                <input type="text" name="name" placeholder="Name" required>
                <input type="text" name="code" placeholder="Code" required>
                <input type="email" name="email" placeholder="Email" required>
                <input type="text" name="phone" placeholder="Phone" required>
                <input type="number" name="discount" placeholder="Discount %" value="10" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn">Add</button>
            </form>
        </div>

        Distributor List</h
    </div>

    <!-- Licenses Section -->
    <div id="licenses" class="section">
        <div class="card">
            <h3>Recent Licenses</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Key</th>
                            <th>Plan</th>
                            <th>Amount</th>
                            <th>Distributor</th>
                            <th>Status</th>
                            <th>Version</th>
                            <th>Expiry</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for l in licenses %}
                        <tr>
                            <td>{{ l.created_at.strftime('%Y-%m-%d') }}</td>
                            <td style="font-family: monospace;">{{ l.license_key }}</td>
                            <td>{{ l.plan_type }}</td>
                            <td>â‚¹{{ l.amount_paid }}</td>
                            <td>{{ l.distributor.name if l.distributor else 'Direct' }}</td>
                            <td>
                                {% if l.is_used %}
                                    <span class="badge badge-green">INSTALLED</span>
                                {% else %}
                                    <span class="badge badge-red">PENDING</span>
                                {% endif %}
                            </td>
                            <td>{{ l.software_version or '-' }}</td>
                            <td>{{ l.expiry_date.strftime('%Y-%m-%d') if l.expiry_date else '-' }}</td>
                            <td>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <form action="/admin/edit_license/{{ l.id }}" method="POST" style="display:inline-flex; gap:4px;">
                                        <select name="status" style="padding: 4px; border-radius: 4px; font-size: 0.8rem;">
                                            <option value="pending" {{ 'selected' if not l.is_used }}>Set Pending</option>
                                            <option value="used" {{ 'selected' if l.is_used }}>Set Installed</option>
                                        </select>
                                        <button type="submit" class="btn btn-sm">Update</button>
                                    </form>
                                    <form action="/admin/delete_license/{{ l.id }}" method="POST" style="display:inline;" onsubmit="return confirm('Delete license?');">
                                        <button type="submit" class="btn btn-sm btn-red">X</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
       function showTab(id) {
    // 1. Hide all content sections
    document.querySelectorAll('.section').forEach(sec => {
        sec.classList.remove('active');
    });

    // 2. Remove 'active' class from all tab buttons
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // 3. Show the selected section
    const targetSection = document.getElementById(id);
    if (targetSection) {
        targetSection.classList.add('active');
    }

    // 4. Highlight the clicked tab button
    // Using event.currentTarget ensures the button is selected even if you click the text inside
    if (event && event.currentTarget) {
        event.currentTarget.classList.add('active');
    }
}
    </script>
</body>
</html>
