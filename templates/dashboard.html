<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        :root { --primary: #111827; --accent: #2563EB; --bg: #F3F4F6; --white: #fff; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; font-size: 0.85rem; text-transform: uppercase; color: #6B7280; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; background: var(--primary); font-size: 0.9rem; text-decoration: none; display: inline-block; }
        .btn-sm { padding: 6px 10px; font-size: 0.8rem; }
        .btn-red { background: #DC2626; }
        .btn-green { background: #10B981; }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; background: #E5E7EB; }
        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-red { background: #FEE2E2; color: #991B1B; }
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { padding: 10px 20px; background: #ddd; cursor: pointer; border-radius: 4px; }
        .tab.active { background: var(--primary); color: white; }
        .section { display: none; }
        .section.active { display: block; }
        
        td input { padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Zarqeen Admin</h1>
        <div>
            <a href="/admin/export/licenses" class="btn">Export Sales</a>
            <a href="/admin/export/distributors" class="btn">Export Distributors</a>
            <a href="/admin/logout" class="btn btn-red">Logout</a>
        </div>
    </div>

    <!-- Stats Section -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div class="card"><h3>Total Licenses</h3><p style="font-size: 2rem; font-weight: bold;">{{ licenses|length }}</p></div>
        <div class="card"><h3>Distributors</h3><p style="font-size: 2rem; font-weight: bold;">{{ distributors|length }}</p></div>
        <div class="card">
            <h3>Global Settings & Bonus</h3>
            <form action="/admin/update_settings" method="POST">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <input type="text" name="bonus_name" value="{{ settings.special_message }}" placeholder="Bonus Message">
                    <div style="display: flex; gap: 5px;">
                        <input type="number" name="bonus" value="{{ settings.special_bonus_percent }}" placeholder="Bonus %" style="width: 70px;">
                        <button type="submit" class="btn">Update</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('distributors')">Distributors</div>
        <div class="tab" onclick="showTab('licenses')">Licenses</div>
    </div>

    <!-- Distributors Section -->
    <div id="distributors" class="section active">
        <div class="card">
            <h3>Add New Partner</h3>
            <form action="/admin/add_distributor" method="POST" class="form-row">
                <input type="text" name="name" placeholder="Name" required>
                <input type="text" name="code" placeholder="Code" required>
                <input type="email" name="email" placeholder="Email" required>
                <input type="text" name="phone" placeholder="Phone" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn">Add</button>
            </form>
        </div>

        <div class="card">
            <h3>Partner List</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Partner Name</th>
                            <th>Code</th>
                            <th>Level</th>
                            <th>Add Payment (‚Çπ)</th>
                            <th>Balance Due</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for d in distributors %}
                        <tr style="{{ 'opacity: 0.5;' if not d.obj.is_enabled }}">
                            <td>
                                <strong>{{ d.obj.name }}</strong><br>
                                <small style="color:gray;">{{ d.obj.email }}</small>
                            </td>
                            <td><code style="color:#2563EB; font-weight:bold;">{{ d.obj.code }}</code></td>
                            <td><span class="badge">{{ d.level_name }}</span></td>
                            <td>
                                <form action="/admin/edit_distributor/{{ d.obj.id }}" method="POST" style="display:flex; gap:5px;">
                                    <input type="number" step="0.01" name="add_payment" placeholder="Amount" style="width: 80px;">
                                    <button type="submit" class="btn btn-sm btn-green">OK</button>
                                </form>
                            </td>
                            <td style="color: {{ 'red' if d.balance > 0 else 'green' }}; font-weight: bold;">
                                ‚Çπ{{ "%.2f"|format(d.balance) }}
                                {% if d.balance >= 500 %}<br><span class="badge badge-green" style="font-size:0.6rem;">READY</span>{% endif %}
                            </td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <a href="/admin/view_distributor/{{ d.obj.id }}" class="btn btn-sm" style="background:#F59E0B;">üëÅÔ∏è View</a>
                                    <form action="/admin/toggle_distributor/{{ d.obj.id }}" method="POST">
                                        <button type="submit" class="btn btn-sm {{ 'btn-red' if d.obj.is_enabled else 'btn-green' }}" style="width: 75px;">
                                            {{ 'Disable' if d.obj.is_enabled else 'Enable' }}
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Licenses Section -->
    <div id="licenses" class="section">
    <div class="card">
        <h3>Recent Licenses</h3>
        <div style="overflow-x:auto;">
            <table style="min-width: 1000px;">
                <thead>
                    <tr>
                        <th>Date Created</th>
                        <th>License Key</th>
                        <th>Plan & Amount</th>
                        <th>User Contact</th> <!-- NEW -->
                        <th>Activation Info</th> <!-- NEW -->
                        <th>Distributor</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for l in licenses %}
                    <tr>
                        <td>{{ l.created_at.strftime('%Y-%m-%d') }}</td>
                        <td style="font-family: monospace; font-size: 0.85rem;">{{ l.license_key }}</td>
                        <td>
                            <div style="font-weight: bold; text-transform: uppercase;">{{ l.plan_type }}</div>
                            <div style="font-size: 0.8rem; color: #666;">‚Çπ{{ l.amount_paid }}</div>
                        </td>
                        <td>
                            <!-- NEW: User Details -->
                            {% if l.is_used %}
                                <div style="font-size: 0.8rem;">
                                    <strong>E:</strong> {{ l.user_email or 'N/A' }}<br>
                                    <strong>P:</strong> {{ l.user_phone or 'N/A' }}
                                </div>
                            {% else %}
                                <span style="color: #999;">Not Activated</span>
                            {% endif %}
                        </td>
                        <td>
                            <!-- NEW: Metadata -->
                            {% if l.is_used %}
                                <div style="font-size: 0.8rem;">
                                    <strong>On:</strong> {{ l.used_at.strftime('%Y-%m-%d %H:%M') if l.used_at else '---' }}<br>
                                    <strong>Ver:</strong> <span class="badge" style="background:#eee; color:#333; border:none;">{{ l.software_version }}</span>
                                </div>
                            {% else %}
                                ---
                            {% endif %}
                        </td>
                        <td>
                            <div>{{ l.distributor.name if l.distributor else 'Direct' }}</div>
                            {% if l.distributor %}
                                <div style="font-size: 0.75rem; color: #059669;">Comm: ‚Çπ{{ l.commission_earned }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {{ 'badge-green' if l.is_used else 'badge-red' }}">
                                {{ 'INSTALLED' if l.is_used else 'PENDING' }}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <form action="/admin/edit_license/{{ l.id }}" method="POST" style="display:flex; gap:2px;">
                                    <select name="status" style="font-size: 0.75rem; padding: 2px;">
                                        <option value="pending" {{ 'selected' if not l.is_used }}>Pending</option>
                                        <option value="used" {{ 'selected' if l.is_used }}>Installed</option>
                                    </select>
                                    <button type="submit" class="btn btn-sm">OK</button>
                                </form>
                                <form action="/admin/delete_license/{{ l.id }}" method="POST" onsubmit="return confirm('Delete?');">
                                    <button type="submit" class="btn btn-sm btn-red">X</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="card" style="margin-top: 20px; border-top: 4px solid #f59e0b;">
    <h3>üì¢ Global Broadcast Control</h3>
    <p style="font-size: 0.8rem; color: #666;">This message will appear at the top of all user's desktop software.</p>
    
    <form action="/admin/update_broadcast" method="POST">
        <div class="form-group">
            <label>Message Content:</label>
            <textarea name="content" rows="2" class="form-control" placeholder="e.g. Happy New Year!"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group">
                <label>Message ID (Unique):</label>
                <input type="text" name="message_id" class="form-control" placeholder="e.g. ny_2026">
                <small>Changing this ID forces the message to show again to users who dismissed the old one.</small>
            </div>
            <div class="form-group">
                <label>Color Style:</label>
                <select name="style" class="form-control">
                    <option value="info">Blue (Info)</option>
                    <option value="success">Green (Success)</option>
                    <option value="warning">Yellow (Warning)</option>
                </select>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="form-group">
                <label>Link Text (Optional):</label>
                <input type="text" name="link_text" class="form-control" placeholder="e.g. Click here">
            </div>
            <div class="form-group">
                <label>Link URL (Optional):</label>
                <input type="text" name="link_url" class="form-control" placeholder="https://...">
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary">Publish Broadcast</button>
    </form>
</div>
    <script>
        function showTab(id) {
            document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (event && event.currentTarget) event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
