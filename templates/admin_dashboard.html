<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zarqeen Admin Panel</title>
    <style>
        :root { --primary: #111827; --accent: #2563EB; --bg: #F3F4F6; --white: #fff; --success: #10B981; --danger: #DC2626; }
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { background: var(--bg); margin: 0; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; color: #4B5563; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; color: white; background: var(--primary); font-size: 0.9rem; text-decoration: none; display: inline-block; }
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; }
        .btn-red { background: var(--danger); }
        .btn-green { background: var(--success); }
        .btn-blue { background: var(--accent); }
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-green { background: #D1FAE5; color: #065F46; }
        .badge-red { background: #FEE2E2; color: #991B1B; }
        .badge-gray { background: #E5E7EB; color: #374151; }
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { padding: 10px 20px; background: #ddd; cursor: pointer; border-radius: 4px; font-weight: 600; }
        .tab.active { background: var(--primary); color: white; }
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Admin Control Center</h1>
        <div>
            <a href="/admin/export/licenses" class="btn btn-blue">Export Sales</a>
            <a href="/admin/export/distributors" class="btn">Export Partners</a>
            <a href="/admin/logout" class="btn btn-red">Logout</a>
        </div>
    </div>

    <!-- KPI Stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div class="card"><h3>Total Revenue</h3><p style="font-size: 1.8rem; font-weight: bold; color: var(--success);">â‚¹{{ licenses|sum(attribute='amount_paid')|round(2) }}</p></div>
        <div class="card"><h3>Active Licenses</h3><p style="font-size: 1.8rem; font-weight: bold;">{{ licenses|length }}</p></div>
        <div class="card">
            <h3>Global Settings</h3>
            <form action="/admin/update_settings" method="POST">
                <div class="form-row">
                    <input type="number" name="bonus" value="{{ settings.special_bonus_percent }}" style="width: 70px;" placeholder="%">
                    <button type="submit" class="btn btn-sm">Update Bonus %</button>
                </div>
            </form>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab(event, 'distributors')">Distributors</div>
        <div class="tab" onclick="showTab(event, 'licenses')">License Management</div>
    </div>

    <!-- Distributors Section -->
    <div id="distributors" class="section active">
        <div class="card">
            <h3>Register New Distributor</h3>
            <form action="/admin/add_distributor" method="POST" class="form-row">
                <input type="text" name="name" placeholder="Full Name" required>
                <input type="text" name="code" placeholder="CODE" required style="text-transform: uppercase;">
                <input type="email" name="email" placeholder="Email" required>
                <input type="text" name="phone" placeholder="Phone">
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-green">Create Account</button>
            </form>
        </div>

        <div class="card">
            <h3>Distributor Management</h3>
            <table>
                <thead>
                    <tr>
                        <th>Partner Info</th>
                        <th>Code</th>
                        <th>Status</th>
                        <th>Commission (Earned / Paid)</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in distributors %}
                    <tr>
                        <form action="/admin/edit_distributor/{{ d.obj.id }}" method="POST">
                            <td>
                                <strong>{{ d.obj.name }}</strong><br>
                                <small>{{ d.obj.email }}</small>
                            </td>
                            <td><span class="badge">{{ d.obj.code }}</span></td>
                            <td>
                                <!-- Status Toggle Logic -->
                                <select name="is_active" class="btn-sm" onchange="this.form.submit()">
                                    <option value="1" {% if d.obj.is_active %}selected{% endif %}>âœ… Active</option>
                                    <option value="0" {% if not d.obj.is_active %}selected{% endif %}>ðŸš« Disabled</option>
                                </select>
                            </td>
                            <td>
                                <small>Earned: â‚¹{{ d.earned }}</small><br>
                                <input type="number" step="0.01" name="manual_paid_total" value="{{ d.obj.commission_paid }}" style="width: 90px; height: 25px; font-size: 0.8rem;">
                            </td>
                            <td style="font-weight: bold; color: {{ 'var(--danger)' if d.balance > 0 else 'var(--success)' }}">
                                â‚¹{{ d.balance|round(2) }}
                            </td>
                            <td>
                                <button type="submit" class="btn btn-sm btn-blue">Save</button>
                                <button type="button" class="btn btn-sm btn-red" onclick="if(confirm('Delete Partner?')) document.getElementById('del-dist-{{d.obj.id}}').submit()">Del</button>
                            </td>
                        </form>
                        <!-- Separate Delete Form -->
                        <form id="del-dist-{{d.obj.id}}" action="/admin/delete_distributor/{{ d.obj.id }}" method="POST" style="display:none;"></form>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Licenses Section -->
    <div id="licenses" class="section">
        <div class="card">
            <h3>Full Sales History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Key Details</th>
                        <th>Plan</th>
                        <th>Price Paid</th>
                        <th>Partner</th>
                        <th>Status</th>
                        <th>Management</th>
                    </tr>
                </thead>
                <tbody>
                    {% for l in licenses %}
                    <tr>
                        <td><small>{{ l.created_at.strftime('%d-%m-%Y %H:%M') }}</small></td>
                        <td>
                            <strong style="font-family: monospace; font-size: 0.8rem;">{{ l.license_key }}</strong><br>
                            <small style="color: #666;">Ver: {{ l.software_version or 'N/A' }}</small>
                        </td>
                        <td><span class="badge badge-gray">{{ l.plan_type|upper }}</span></td>
                        <td>â‚¹{{ l.amount_paid }}</td>
                        <td>{{ l.distributor.name if l.distributor else 'Direct Web' }}</td>
                        <td>
                            {% if l.is_used %}
                                <span class="badge badge-green">INSTALLED</span><br>
                                <small>Exp: {{ l.expiry_date.strftime('%Y-%m-%d') if l.expiry_date else '-' }}</small>
                            {% else %}
                                <span class="badge badge-red">PENDING</span>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <a href="/download/license/{{ l.license_key }}" class="btn btn-sm" title="Download .zarqeen file">ðŸ’¾ Download</a>
                                
                                <form action="/admin/edit_license/{{ l.id }}" method="POST">
                                    <input type="hidden" name="status" value="{{ 'pending' if l.is_used else 'used' }}">
                                    <button type="submit" class="btn btn-sm btn-blue">Toggle</button>
                                </form>

                                <form action="/admin/delete_license/{{ l.id }}" method="POST" onsubmit="return confirm('Permanently delete key?');">
                                    <button type="submit" class="btn btn-sm btn-red">X</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function showTab(event, id) {
            document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
