<!-- بِسْمِ ٱللَّهِ ٱلرَّحْمَـٰنِ ٱلرَّحِيمِ  -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zarqeen Alif - India's Best Value Invoicing Software</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="icon" type="image/png" href="static/header.png">
    
    <style>
        :root { --primary: #2563EB; --primary-dark: #1E40AF; --text: #1F2937; --muted: #6B7280; --bg: #F3F4F6; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); }
        a { text-decoration: none; cursor: pointer; }
        
        /* HEADER */
        header { background: white; padding: 1rem 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.2rem; color: var(--primary-dark); }
        .logo img { height: 40px; }
        .nav { display: flex; gap: 20px; align-items: center; }
        .nav a { color: var(--muted); font-weight: 500; transition: 0.2s; }
        .nav a:hover { color: var(--primary); }
        .nav-btn { background: var(--primary); color: white !important; padding: 0.5rem 1.2rem; border-radius: 6px; }
        
        /* MOBILE MENU */
        .menu-btn { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .mobile-menu { display: none; position: absolute; top: 70px; left: 0; width: 100%; background: white; padding: 20px; flex-direction: column; gap: 15px; border-bottom: 1px solid #eee; }
        @media (max-width: 768px) { .nav { display: none; } .menu-btn { display: block; } }

        /* HERO & CARDS */
        .hero { text-align: center; padding: 4rem 1rem; background: linear-gradient(to bottom, white, #EFF6FF); }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1rem; line-height: 1.2; }
        .pricing-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; max-width: 1000px; margin: 40px auto; padding: 0 20px; }
        .card { background: white; padding: 2rem; border-radius: 12px; border: 1px solid #E5E7EB; text-align: center; display: flex; flex-direction: column; }
        .card.popular { border: 2px solid var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); transform: scale(1.05); }
        
        /* FORMS & BUTTONS */
        input { width: 100%; padding: 12px; margin: 8px 0 15px; border: 1px solid #D1D5DB; border-radius: 6px; font-size: 0.95rem; }
        .btn { width: 100%; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #E5E7EB; color: #374151; }
        .btn-disabled { opacity: 0.6; cursor: not-allowed; }

        /* MODALS (Fixed Styling) */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); align-items: center; justify-content: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 2rem; border-radius: 16px; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .close { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; color: #999; }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; }
        .tab.active { color: var(--primary); border-color: var(--primary); font-weight: 600; }
        
        /* DASHBOARD */
        #dashSection { display: none; padding: 2rem 5%; min-height: 100vh; }
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-num { font-size: 2rem; font-weight: 700; color: var(--primary); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 0.9rem; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9fafb; font-weight: 600; }
        
        /* LOADER */
        #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 3000; align-items: center; justify-content: center; flex-direction: column; }
        .spin { width: 40px; height: 40px; border: 4px solid #eee; border-top: 4px solid var(--primary); border-radius: 50%; animation: s 1s linear infinite; }
        @keyframes s { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader"><div class="spin"></div><p id="loadText" style="margin-top:10px;font-weight:600;">Loading...</p></div>

    <!-- HEADER -->
    <header>
        <div class="logo"><img src="static/logo.png"> Zarqeen Alif</div>
        <div class="nav">
            <a onclick="openModal('registerModal')">Join as Partner</a>
            <a onclick="openModal('loginModal')">Login</a>
            <a href="https://drive.google.com/drive/folders/17O3vY4KYUzd7Rma4o8rp3j2iIrpqhJe9" class="nav-btn">Download</a>
        </div>
        <button class="menu-btn" onclick="document.getElementById('mobMenu').style.display = document.getElementById('mobMenu').style.display=='flex'?'none':'flex'">☰</button>
    </header>
    <div id="mobMenu" class="mobile-menu">
        <a onclick="openModal('registerModal')">Join as Partner</a>
        <a onclick="openModal('loginModal')">Login</a>
        <a href="https://drive.google.com/drive/folders/17O3vY4KYUzd7Rma4o8rp3j2iIrpqhJe9">Download</a>
    </div>

    <!-- HERO -->
    <section class="hero" id="mainSection">
        <div style="background:#DBEAFE;color:#1E40AF;padding:5px 15px;border-radius:20px;display:inline-block;font-weight:bold;font-size:0.8rem;margin-bottom:15px;">MADE FOR INDIA</div>
        <h1>Simple Billing for<br><span style="color:var(--primary)">Retail Businesses</span></h1>
        <p style="color:#666; max-width:600px; margin:0 auto 30px;">Supports A4, A5, and Thermal 2"/3". No internet required.</p>
        <button onclick="document.getElementById('pricing').scrollIntoView()" class="btn-primary" style="padding:1rem 2rem; border-radius:8px; border:none; cursor:pointer;">Get License</button>
    </section>

    <!-- PRICING -->
    <section id="pricing" style="padding:4rem 1rem; text-align:center;">
        <h2 style="margin-bottom:2rem;">Pricing</h2>
        
        <div style="max-width:400px; margin:0 auto 2rem; display:flex; gap:10px;">
            <input type="text" id="distCode" placeholder="Enter Distributor Code" style="margin:0; text-transform:uppercase;">
            <button onclick="applyCode()" class="btn-primary" style="width:auto; margin:0;">Apply</button>
        </div>
        <p id="codeMsg" style="height:20px; margin-top:-10px; font-size:0.9rem;"></p>

        <div class="pricing-grid">
            <div class="card"><h3>Basic</h3><div style="font-size:2.5rem;font-weight:bold;margin:10px 0;">₹299</div><p>1 Year License</p><button onclick="buyPlan('basic')" class="btn btn-primary">Buy Now</button></div>
            <div class="card popular"><h3>Premium</h3><div style="font-size:2.5rem;font-weight:bold;margin:10px 0;">₹599</div><p>3 Year License</p><button onclick="buyPlan('premium')" class="btn btn-primary">Buy Now</button></div>
        </div>
    </section>

    <!-- DISTRIBUTOR DASHBOARD -->
    <div id="dashSection">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Dashboard</h2>
            <button onclick="logout()" class="btn btn-secondary" style="width:auto;">Logout</button>
        </div>
        
        <div style="background:white; padding:15px; border-radius:8px; margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
            <div>
                <p style="margin:0; color:#666;">Code: <strong id="d_code" style="color:black; font-family:monospace; font-size:1.2rem;"></strong></p>
                <div id="d_level" style="font-size:0.8rem; background:gold; padding:2px 8px; border-radius:10px; display:inline-block; margin-top:5px;"></div>
            </div>
            <div style="text-align:right;">
                <div id="d_disc" style="font-weight:bold; color:var(--primary);"></div>
                <small style="color:#666;">Discount</small>
            </div>
        </div>

        <div class="dash-grid">
            <div class="stat-box"><div class="stat-num" id="d_sales">0</div>Total Sales</div>
            <div class="stat-box"><div class="stat-num" style="color:#059669;" id="d_paid">₹0</div>Paid</div>
            <div class="stat-box"><div class="stat-num" style="color:#DC2626;" id="d_bal">₹0</div>Balance</div>
        </div>

        <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>Banking</h3>
                <button onclick="openModal('bankModal')" style="background:none; border:none; color:var(--primary); cursor:pointer;">Edit</button>
            </div>
            <p id="bank_details" style="color:#555; line-height:1.6; font-size:0.9rem;">-</p>
        </div>

        <h3>Sales History</h3>
        <div style="overflow-x:auto;">
            <table id="salesTable"><thead><tr><th>Date</th><th>Plan</th><th>Amt</th><th>Key</th><th>Link</th></tr></thead><tbody></tbody></table>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- LOGIN -->
    <div id="loginModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">Login</h2>
            <div class="tabs">
                <div class="tab active" onclick="switchTab(this, 'user')">Distributor</div>
                <div class="tab" onclick="switchTab(this, 'admin')">Admin</div>
            </div>
            
            <form id="distForm">
                <input type="email" name="email" placeholder="Email" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary">Login</button>
                <p style="text-align:center; font-size:0.8rem; margin-top:10px; color:var(--primary); cursor:pointer;" onclick="startForgot()">Forgot Password?</p>
            </form>

            <form id="adminForm" style="display:none;" method="POST">
                <input type="text" name="username" placeholder="Username" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary" style="background:#111;">Admin Login</button>
            </form>
        </div>
    </div>

    <!-- REGISTER -->
    <div id="registerModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2 style="text-align:center;">Partner Registration</h2>
            <form id="regForm">
                <input type="text" name="name" placeholder="Full Name" required>
                <input type="email" name="email" placeholder="Email" required>
                <input type="text" name="phone" placeholder="Phone" required>
                <input type="password" name="password" placeholder="Password" required>
                <button type="submit" class="btn btn-primary">Register</button>
            </form>
            <div id="otpSec" style="display:none; margin-top:15px;">
                <input type="text" id="regOtp" placeholder="Enter OTP" style="text-align:center; letter-spacing:5px;">
                <button onclick="verifyReg()" class="btn btn-primary">Verify & Join</button>
            </div>
        </div>
    </div>

    <!-- BANK -->
    <div id="bankModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bankModal')">&times;</span>
            <h3>Update Banking</h3>
            <form id="bankForm">
                <input type="text" name="bank_name" placeholder="Bank Name">
                <input type="text" name="account_holder" placeholder="Holder Name">
                <input type="text" name="account_number" placeholder="Account No">
                <input type="text" name="ifsc_code" placeholder="IFSC">
                <input type="text" name="upi_id" placeholder="UPI ID">
                <button type="submit" class="btn btn-primary">Save Details</button>
            </form>
        </div>
    </div>

    <!-- LICENSE DISPLAY -->
    <div id="licModal" class="modal" style="display:none;">
        <div class="modal-content" style="text-align:center;">
            <h2 style="color:var(--success)">Success!</h2>
            <p>Download your license file below.</p>
            <div id="licBtnArea" style="margin-top:20px;"></div>
            <button onclick="closeModal('licModal'); location.reload();" class="btn btn-secondary">Close</button>
        </div>
    </div>

    <script>
        const API = "https://zarqeen-backend.onrender.com";
        document.getElementById('adminForm').action = `${API}/admin/login`;
        let RZP_KEY = null;

        // UI UTILS
        function loader(s) { document.getElementById('loader').style.display = s ? 'flex' : 'none'; }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function switchTab(el, type) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('distForm').style.display = type=='user'?'block':'none';
            document.getElementById('adminForm').style.display = type=='admin'?'block':'none';
        }

        // INIT
        async function init() {
            try { const r = await fetch(`${API}/api/get-config`); const d = await r.json(); RZP_KEY = d.key_id; } catch{}
            const token = localStorage.getItem('dt');
            if(token) loadDash(token);
        }
        init();

        // AUTH
        document.getElementById('distForm').addEventListener('submit', async e => {
            e.preventDefault(); loader(true);
            const d = Object.fromEntries(new FormData(e.target));
            try {
                const r = await fetch(`${API}/api/distributor/login`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(d)});
                const j = await r.json();
                loader(false);
                if(j.success) { localStorage.setItem('dt', j.token); closeModal('loginModal'); loadDash(j.token); }
                else alert(j.message);
            } catch { loader(false); alert('Error'); }
        });

        // REGISTER FLOW
        let regData = {};
        document.getElementById('regForm').addEventListener('submit', async e => {
            e.preventDefault(); loader(true);
            regData = Object.fromEntries(new FormData(e.target));
            try {
                const r = await fetch(`${API}/api/distributor/register`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(regData)});
                const j = await r.json();
                loader(false);
                if(j.success) { alert(j.message); document.getElementById('regForm').style.display='none'; document.getElementById('otpSec').style.display='block'; }
                else alert(j.message);
            } catch { loader(false); }
        });

        async function verifyReg() {
            const otp = document.getElementById('regOtp').value;
            loader(true);
            try {
                const r = await fetch(`${API}/api/distributor/verify-registration`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email:regData.email, otp})});
                const j = await r.json();
                loader(false);
                if(j.success) { alert("Registered! Please Login."); location.reload(); }
                else alert(j.message);
            } catch { loader(false); }
        }

        // DASHBOARD
        async function loadDash(token) {
            loader(true);
            try {
                const r = await fetch(`${API}/api/distributor/data`, {headers:{'Authorization':token}});
                if(r.status==401) { logout(); return; }
                const d = await r.json();
                
                document.getElementById('mainSection').style.display='none';
                document.getElementById('pricing').style.display='none';
                document.getElementById('dashSection').style.display='block';
                
                // Fill Data
                document.getElementById('d_code').innerText = d.code;
                document.getElementById('d_level').innerText = "Discount: " + d.discount + "%";
                document.getElementById('d_sales').innerText = d.total_sales;
                document.getElementById('d_paid').innerText = "₹" + d.commission_paid;
                document.getElementById('d_bal').innerText = "₹" + d.balance_due;
                
                // Bank
                const b = d.bank_info;
                document.getElementById('bank_details').innerHTML = `
                    <b>${b.bank_name||'-'}</b><br>
                    Acct: ${b.account_number||'-'}<br>
                    IFSC: ${b.ifsc||'-'}<br>
                    UPI: ${b.upi||'-'}
                `;
                // Fill form for editing
                const f = document.getElementById('bankForm');
                f.bank_name.value=b.bank_name||''; f.account_holder.value=b.account_holder||''; 
                f.account_number.value=b.account_number||''; f.ifsc_code.value=b.ifsc||''; f.upi_id.value=b.upi||'';

                // Table
                const t = document.getElementById('salesTable').querySelector('tbody');
                t.innerHTML = d.sales_history.map(s => `
                    <tr>
                        <td>${s.date}</td>
                        <td>${s.plan}</td>
                        <td>₹${s.amount}</td>
                        <td>${s.key}</td>
                        <td><a href="${d.backend_url}download/license/${s.key}" class="btn-secondary" style="padding:2px 8px; font-size:0.8rem; border-radius:4px;">⬇</a></td>
                    </tr>
                `).join('');

                loader(false);
            } catch { logout(); }
        }

        function logout() { localStorage.removeItem('dt'); location.reload(); }

        // BANK UPDATE
        document.getElementById('bankForm').addEventListener('submit', async e => {
            e.preventDefault(); loader(true);
            const d = Object.fromEntries(new FormData(e.target));
            const t = localStorage.getItem('dt');
            await fetch(`${API}/api/distributor/update-bank`, {method:'POST', headers:{'Content-Type':'application/json', 'Authorization':t}, body:JSON.stringify(d)});
            alert("Saved"); closeModal('bankModal'); loadDash(t);
        });

        // PAYMENT
        let CODE = null;
        async function applyCode() {
            const c = document.getElementById('distCode').value;
            const res = await fetch(`${API}/api/check_distributor`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({code:c})});
            const d = await res.json();
            if(d.valid) { CODE=c; document.getElementById('codeMsg').innerText=`Applied: ${d.name} (${d.discount}%)`; document.getElementById('codeMsg').style.color='green'; }
            else { CODE=null; document.getElementById('codeMsg').innerText="Invalid Code"; document.getElementById('codeMsg').style.color='red'; }
        }

        async function buyPlan(p) {
            loader(true);
            try {
                const r1 = await fetch(`${API}/create_order`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({plan:p, distributor_code:CODE})});
                const o = await r1.json();
                loader(false);
                
                const opts = {
                    key: RZP_KEY, amount: o.amount, currency: "INR", order_id: o.id, name: "Zarqeen Alif",
                    handler: async function(resp) {
                        loader(true);
                        const r2 = await fetch(`${API}/verify_payment`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({...resp, plan_type:p})});
                        const res = await r2.json();
                        loader(false);
                        if(res.success) {
                            const blob = new Blob([res.license_key], {type:"text/plain"});
                            const url = URL.createObjectURL(blob);
                            document.getElementById('licBtnArea').innerHTML = `<a href="${url}" download="license.zarqeen" class="btn btn-primary">Download File</a>`;
                            openModal('licModal');
                        } else alert("Failed");
                    }
                };
                new Razorpay(opts).open();
            } catch { loader(false); alert("Error"); }
        }
    </script>
</body>
</html>
