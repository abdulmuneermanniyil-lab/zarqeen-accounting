<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zarqeen Alif - Smart Billing</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- [Keep your existing CSS Styles here] -->
</head>
<body>
    <div id="actionLoader" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; flex-direction:column; align-items:center; justify-content:center;">
        <div class="spinner"></div><div id="loaderText">Loading Secure Environment...</div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="nav-container">
            <div class="logo-area"><img src="static/logo.png" style="height:45px;"><span class="brand-name">Zarqeen Alif</span></div>
            <nav class="nav-links">
                <a onclick="openRegisterModal()">Partner</a>
                <a onclick="openLoginModal()">Login</a>
                <a id="navDownBtn" class="nav-btn" onclick="checkDownload(event)">Download</a>
            </nav>
        </div>
    </header>

    <!-- DASHBOARD SECTION -->
    <div id="dashboardSection" style="display:none; padding:40px 20px;">
        <div class="dash-header">
            <h2 id="distNameDisplay">Welcome</h2>
            <button onclick="logout()" class="btn-buy secondary" style="width:auto;">Logout</button>
        </div>
        
        <!-- FINANCIAL SUMMARY CARDS -->
        <div class="dash-grid">
            <div class="dash-card"><div class="dash-label">Total Commission</div><div class="dash-val">₹<span id="commEarned">0</span></div></div>
            <div class="dash-card"><div class="dash-label">Already Paid</div><div class="dash-val" style="color:#059669;">₹<span id="commPaid">0</span></div></div>
            <div class="dash-card"><div class="dash-val" style="color:#DC2626;">₹<span id="commBalance">0</span></div><div class="dash-label">Pending Balance</div></div>
        </div>

        <h3>License Sales History</h3>
        <table class="dash-table">
            <thead><tr><th>Date</th><th>Plan</th><th>Paid</th><th>Status</th><th>License Key</th><th>Action</th></tr></thead>
            <tbody id="historyTable"></tbody>
        </table>
    </div>

    <!-- [Keep your existing Registration, Bank, and Login Modals] -->

    <script>
        let CONFIG = {};

        // 1. SECURE HANDSHAKE
        async function initApp() {
            try {
                const res = await fetch('/api/v1/config');
                CONFIG = await res.json();
                
                // Set Version text if exists
                if(document.getElementById('vText')) document.getElementById('vText').innerText = CONFIG.VERSION;
                
                // Set Download Links
                document.querySelectorAll('.nav-btn, .cta-group a, #navDownBtn').forEach(a => a.href = CONFIG.DOWNLOAD_LINK);
            } catch(e) { console.error("Server Link Failed"); }
        }

        // 2. PROTECTED ADMIN LOGIN
        document.getElementById('adminForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            showLoader("Verifying...");
            const data = Object.fromEntries(new FormData(this));
            try {
                const res = await fetch(`${CONFIG.BACKEND_URL}/admin/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data),
                    credentials: 'include'
                });
                const result = await res.json();
                hideLoader();
                if(result.success) window.location.href = result.redirect;
                else Swal.fire('Error', result.message, 'error');
            } catch(e) { hideLoader(); Swal.fire('Error', 'Backend Unreachable', 'error'); }
        });

        // 3. DISTRIBUTOR DASHBOARD DATA
        async function loadDistData() {
            const token = localStorage.getItem('dist_token');
            if(!token) return;
            const res = await fetch(`${CONFIG.BACKEND_URL}/api/distributor/data`, {
                headers: {'Authorization': `Bearer ${token}`}
            });
            if(res.status === 401) { logout(); return; }
            const data = await res.json();
            
            document.getElementById('distNameDisplay').innerText = data.name;
            document.getElementById('commEarned').innerText = data.earned;
            document.getElementById('commPaid').innerText = data.paid;
            document.getElementById('commBalance').innerText = data.balance;

            let html = "";
            data.history.forEach(row => {
                html += `<tr>
                    <td>${row.date}</td>
                    <td><b>${row.plan}</b></td>
                    <td>₹${row.amount}</td>
                    <td><span class="status-badge ${row.status === 'USED' ? 'status-installed' : 'status-pending'}">${row.status}</span></td>
                    <td style="font-family:monospace;">${row.key}</td>
                    <td><a href="${CONFIG.BACKEND_URL}/download/license/${row.key}" class="nav-btn" style="padding:2px 8px; font-size:0.7rem;">Download</a></td>
                </tr>`;
            });
            document.getElementById('historyTable').innerHTML = html;
            
            // Toggle view
            document.querySelector('header').style.display='none';
            document.getElementById('dashboardSection').style.display='block';
        }

        function logout() { localStorage.removeItem('dist_token'); location.reload(); }
        function showLoader(t) { document.getElementById('actionLoader').style.display='flex'; document.getElementById('loaderText').innerText=t; }
        function hideLoader() { document.getElementById('actionLoader').style.display='none'; }
        
        window.onload = initApp;
    </script>
</body>
</html>
