<!-- ÿ®Ÿêÿ≥ŸíŸÖŸê Ÿ±ŸÑŸÑŸëŸéŸáŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸíŸÖŸéŸÄŸ∞ŸÜŸê Ÿ±ŸÑÿ±ŸëŸéÿ≠ŸêŸäŸÖŸê  -->
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Zarqeen Alif - India's Best Value Invoicing Software</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="icon" type="image/png" href="static/header.png">
    
    <style>
        :root { --primary: #2563EB; --primary-dark: #1E40AF; --accent: #F59E0B; --bg-light: #F3F4F6; --text-main: #111827; --text-muted: #6B7280; --white: #ffffff; --success: #10B981; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        body { background-color: var(--bg-light); color: var(--text-main); line-height: 1.6; }
        a { text-decoration: none; } ul { list-style: none; }
        
        /* LOADER */
        #actionLoader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 999999; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #E5E7EB; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        header { background: var(--white); box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .nav-container { max-width: 1200px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
        .logo-area { display: flex; align-items: center; gap: 12px; }
        .logo-img { height: 45px; width: auto; }
        .brand-name { font-weight: 800; font-size: 1.35rem; color: var(--primary-dark); tracking: -0.5px; }
        .nav-links { display: flex; align-items: center; gap: 2rem; }
        .nav-links a { color: var(--text-muted); font-weight: 600; font-size: 0.95rem; transition: color 0.2s; cursor: pointer; }
        .nav-links a:hover { color: var(--primary); }
        .nav-btn { background: var(--primary); color: var(--white) !important; padding: 0.6rem 1.2rem; border-radius: 8px; transition: background 0.2s; }
        
        /* MOBILE NAV */
        .mobile-menu-btn { display: none; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-main); }
        .mobile-nav { display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border-bottom: 1px solid #eee; padding: 1rem; flex-direction: column; gap: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); z-index: 999; }
        .mobile-nav a { display: block; padding: 10px 0; border-bottom: 1px solid #f3f4f6; color: var(--text-main); font-weight: 600; }
        @media (max-width: 768px) { .nav-links { display: none; } .mobile-menu-btn { display: block; } .mobile-nav.active { display: flex; } }
        
        .hero { text-align: center; padding: 5rem 1rem 4rem; background: linear-gradient(180deg, #FFFFFF 0%, #EFF6FF 100%); border-bottom: 1px solid #DBEAFE; }
        .tagline { display: inline-block; background: #DBEAFE; color: var(--primary-dark); padding: 6px 16px; border-radius: 50px; font-size: 0.85rem; font-weight: 700; margin-bottom: 1.5rem; border: 1px solid #BFDBFE; }
        .hero h1 { font-size: 3rem; font-weight: 800; color: #111827; line-height: 1.2; margin-bottom: 1.5rem; letter-spacing: -1px; }
        .hero h1 span { color: var(--primary); }
        .hero p { font-size: 1.2rem; color: var(--text-muted); max-width: 700px; margin: 0 auto 2.5rem; }
        .cta-group { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        
        .btn-lg { padding: 1rem 2rem; font-size: 1.1rem; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: transform 0.2s; }
        .btn-lg:hover { transform: translateY(-2px); }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-outline { background: var(--white); color: var(--text-main); border: 1px solid #D1D5DB; }
        .specs { font-size: 0.85rem; color: var(--text-muted); margin-top: 1.5rem; opacity: 0.8; }
        .features { max-width: 1200px; margin: -3rem auto 3rem; padding: 0 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2rem; position: relative; z-index: 10; }
        .feature-card { background: var(--white); padding: 2rem; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); border: 1px solid #E5E7EB; transition: transform 0.2s; }
        .feature-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .icon-box { font-size: 2rem; margin-bottom: 1rem; background: #EFF6FF; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .feature-card h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; color: #1F2937; }
        
        .pricing-section { padding: 4rem 1rem; text-align: center; }
        .section-title { font-size: 2.25rem; font-weight: 800; margin-bottom: 0.5rem; }
        .section-subtitle { color: var(--text-muted); margin-bottom: 3rem; font-size: 1.1rem; }
        .dist-input-container { max-width: 400px; margin: 0 auto 2rem; text-align: center; }
        .dist-input-box { display: flex; gap: 10px; justify-content: center; margin-top: 5px; }
        .dist-input { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 60%; text-transform: uppercase; font-weight: bold; }
        .pricing-grid { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; align-items: start; }
        .plan-card { background: var(--white); padding: 2.5rem; border-radius: 16px; border: 1px solid #E5E7EB; position: relative; display: flex; flex-direction: column; height: 100%; transition: 0.3s; }
        .plan-card.popular { border: 2px solid var(--primary); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); transform: scale(1.05); z-index: 2; }
        .badge { position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: var(--accent); color: #78350F; padding: 6px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase; }
        .plan-name { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; color: #1F2937; }
        .price { font-size: 3rem; font-weight: 800; color: #111827; }
        .price span { font-size: 1rem; color: var(--text-muted); font-weight: 500; }
        .plan-desc { color: var(--text-muted); margin-bottom: 2rem; font-size: 0.95rem; border-bottom: 1px solid #E5E7EB; padding-bottom: 1.5rem; }
        .features-list { list-style: none; text-align: left; margin-bottom: 2rem; }
        .features-list li { margin-bottom: 0.8rem; color: #374151; display: flex; align-items: center; gap: 10px; font-size: 0.95rem; }
        .features-list li::before { content: "‚úì"; color: var(--success); font-weight: 800; }
        
        .btn-buy { width: 100%; padding: 1rem; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; border: none; transition: 0.2s; margin-top: auto; }
        .btn-buy.primary { background: var(--primary); color: var(--white); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .btn-buy.primary:hover { background: var(--primary-dark); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .btn-buy.secondary { background: #E5E7EB; color: #374151; }
        .btn-buy.secondary:hover { background: #D1D5DB; }
        .btn-disabled { background: #E5E7EB !important; color: #9CA3AF !important; cursor: not-allowed; box-shadow: none !important; }
        footer { margin-top: 4rem; padding: 3rem 1rem; background: var(--white); border-top: 1px solid #E5E7EB; text-align: center; }

        /* MODALS */
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(4px); overflow-y: auto; padding: 10px; align-items: flex-start; }
        .modal-content { background-color: var(--white); margin: 5vh auto; padding: 2rem; border-radius: 12px; width: 100%; max-width: 450px; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); max-height: 85vh; overflow-y: auto; }
        .close-icon { position: absolute; right: 20px; top: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
        .key-box { background: #F3F4F6; padding: 1rem; border: 2px dashed #D1D5DB; border-radius: 8px; margin: 1.5rem 0; font-family: monospace; font-size: 1.1rem; color: var(--primary-dark); word-break: break-all; }
        
        .login-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #E5E7EB; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; font-weight: 600; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .login-form { display: none; }
        .login-form.active { display: block; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #D1D5DB; border-radius: 6px; }

        #dashboardSection { display: none; padding: 2rem; background: #F3F4F6; min-height: 100vh; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dash-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .dash-val { font-size: 2rem; font-weight: 700; color: var(--primary); }
        .dash-table { width: 100%; background: white; border-radius: 12px; border-collapse: collapse; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .dash-table th, .dash-table td { padding: 15px; text-align: left; border-bottom: 1px solid #E5E7EB; }
        .dash-table th { background: #F9FAFB; font-weight: 600; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; }
        .status-installed { background: #D1FAE5; color: #065F46; }
        .status-pending { background: #FEE2E2; color: #991B1B; }
        .level-badge { background: gold; color: black; padding: 2px 8px; border-radius: 20px; font-size: 0.8rem; margin-left: 10px; border: 1px solid #eab308; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 768px) { .nav-links { display: none; } .mobile-menu-btn { display: block; } .mobile-nav.active { display: flex; } .hero h1 { font-size: 2.25rem; } }
    </style>
</head>
<body>
    <div id="actionLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); z-index: 999999; flex-direction: column; align-items: center; justify-content: center;">
        <div class="spinner"></div>
        <div id="loaderText" style="font-weight:600; margin-bottom:5px;">Loading...</div>
        <div id="loaderSubText" style="font-size:0.9rem; color:gray">Waking up server... please wait.</div>
    </div>

    <header>
        <div class="nav-container">
            <div class="logo-area"><img src="static/logo.png" style="height:45px;"><span class="brand-name" style="margin-left:10px;font-size:1.3rem;font-weight:800;color:#1E40AF;">Zarqeen Alif</span></div>
            <nav class="nav-links">
                <a onclick="openRegisterModal()" style="color:var(--primary); cursor:pointer;">Join as Distributor</a>
                <a onclick="openLoginModal()" style="color:var(--primary); cursor:pointer;">Login</a>
                <a href="https://drive.google.com/drive/folders/17O3vY4KYUzd7Rma4o8rp3j2iIrpqhJe9?usp=drive_link" target="_blank" class="nav-btn" onclick="checkDownload(event)">Download</a>
            </nav>
            <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
        </div>
        <div class="mobile-nav" id="mobileNav">
            <a onclick="toggleMobileMenu(); openRegisterModal()">Join as Distributor</a>
            <a onclick="toggleMobileMenu(); openLoginModal()">Login</a>
            <a href="https://drive.google.com/drive/folders/17O3vY4KYUzd7Rma4o8rp3j2iIrpqhJe9?usp=drive_link" target="_blank" onclick="checkDownload(event)">Download Software</a>
        </div>
    </header>

    <section class="hero">
        <div class="tagline"><img src="https://flagcdn.com/w40/in.png" alt="India" style="height:14px; margin-right:5px;"> MADE FOR INDIA</div>
        <h1>India's Best Value <br><span>Invoicing Software</span></h1>
        <p>The easiest offline billing software. Automatically calculates taxes. <strong>Specially designed for Retail Indian Businesses</strong> who want simplicity and speed.</p>
        <div class="cta-group">
            <a href="https://drive.google.com/drive/folders/17O3vY4KYUzd7Rma4o8rp3j2iIrpqhJe9?usp=drive_link" target="_blank" onclick="checkDownload(event)"><button class="btn-lg btn-primary">Download Free Trial</button></a>
        </div>
        <div class="specs">v1.1.0 ‚Ä¢ Supports A4, A5, Thermal 2" & 3" ‚Ä¢ 200MB ‚Ä¢ No Internet Required</div>
    </section>

    <section id="features" class="features">
        <div class="feature-card"><div class="icon-box">‚ö°</div><h3>Lightning Fast & Offline</h3><p>Generates bills in seconds. Works 100% offline so your data stays safe on your own computer. No cloud fees.</p></div>
        <div class="feature-card"><div class="icon-box">üñ®Ô∏è</div><h3>All Paper Sizes</h3><p>Supports A4, A5, and Thermal Printers (2-inch & 3-inch). Print perfectly on any device.</p></div>
        <div class="feature-card"><div class="icon-box"><img src="https://flagcdn.com/w80/in.png" style="width:35px;"></div><h3>Exclusively for India</h3><p>Built specifically for the Indian market. Pre-loaded with Indian State codes and currency formats.</p></div>
    </section>

    <section id="pricing" class="pricing-section">
        <h2 class="section-title">Unbeatable Pricing</h2>
        <div class="dist-input-container">
            <p style="margin-bottom:10px; font-weight:600;">Have a Distributor Code?</p>
            <div class="dist-input-box">
                <input type="text" id="distCode" class="dist-input" placeholder="Enter Code (e.g. ZARQEEN10)">
                <button onclick="applyCode()" class="nav-btn" style="cursor:pointer;">Apply</button>
            </div>
            <p id="codeMsg" style="font-size:0.9rem; margin-top:5px; min-height:20px;"></p>
        </div>
        <div class="pricing-grid">
            <div class="plan-card"><div class="plan-name">Trial</div><div class="price">Free</div><p class="plan-desc">7 Days unlimited access</p><a href="https://drive.google.com/drive/folders/17O3vY4KYUzd7Rma4o8rp3j2iIrpqhJe9?usp=drive_link" target="_blank" style="margin-top:auto;"><button class="btn-buy secondary">Download Now</button></a></div>
            <div class="plan-card"><div class="plan-name">Basic</div><div class="price">‚Çπ299<span>/year</span></div><p class="plan-desc">Ideal for new customers</p><button class="btn-buy primary" onclick="buyPlan('basic')">Buy Basic License</button></div>
            <div class="plan-card popular"><div class="badge">BEST VALUE</div><div class="plan-name">Premium</div><div class="price">‚Çπ599<span>/3 years</span></div><p class="plan-desc">For smart business owners</p><button class="btn-buy primary" onclick="buyPlan('premium')">Buy Premium License</button></div>
        </div>
    </section>

    <footer>
        <p>&copy; <span id="year"></span> Zarqeen Accounting Solutions.</p>
        <div class="footer-admin"><a onclick="openLoginModal()" style="cursor:pointer;">Admin / Distributor Login</a></div>
    </footer>

    <!-- DISTRIBUTOR DASHBOARD -->
    <div id="dashboardSection">
        <div style="max-width:1200px; margin:0 auto;">
            <div class="dash-header">
                <div><h2 id="dashName">Distributor</h2><p style="color:#6B7280;">Code: <strong id="dashCode"></strong></p></div>
                <button onclick="doLogout()" class="btn-buy secondary" style="width:auto; margin:0; background:#EF4444; color:white;">Logout</button>
            </div>
            <div class="dash-grid">
                <div class="dash-card"><div class="dash-val" id="dashTotal">0</div><div style="font-size:0.9rem" id="dashTargetMsg">Total Sales</div></div>
                <div class="dash-card"><div class="dash-val">‚Çπ<span id="dashComm">0.00</span></div><div>Financials</div></div>
                <div class="dash-card" style="position:relative; overflow:hidden;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div class="dash-val" style="font-size:1.5rem; color:#d97706;" id="lvlName">Bronze</div>
                        <span style="font-size:0.8rem; background:#FEF3C7; color:#92400E; padding:2px 6px; border-radius:4px;" id="lvlDisc">10% Off</span>
                    </div>
                    <div style="margin-top:10px; font-size:0.85rem; color:#6B7280;"><span id="lvlMsg">0 / 5 to Silver</span></div>
                    <div style="background:#E5E7EB; height:6px; width:100%; border-radius:10px; margin-top:5px;"><div id="lvlBar" style="background:#d97706; height:100%; width:0%; border-radius:10px; transition:width 0.5s;"></div></div>
                    <div style="font-size:0.75rem; color:#9CA3AF; margin-top:5px;">Based on this month's performance</div>
                </div>
            </div>
            <div class="dash-header" style="margin-top:-10px;">
                <div style="display:flex; justify-content:space-between; width:100%;"><h3>My Banking Details</h3><button onclick="openBankModal()" class="nav-btn" style="padding:5px 10px; font-size:0.8rem;">Edit Details</button></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; font-size:0.95rem; margin-top:10px;">
                    <div><p>Bank: <strong id="d_bank"></strong></p><p>Holder: <strong id="d_holder"></strong></p></div>
                    <div><p>Acct: <strong id="d_acct"></strong></p><p>IFSC: <strong id="d_ifsc"></strong></p><p>UPI: <strong id="d_upi"></strong></p></div>
                </div>
            </div>
            <h3 style="margin-bottom:15px; display:flex; justify-content:space-between;">Sales History <span id="pageInfo" style="font-size:0.9rem; color:gray"></span></h3>
            <div style="overflow-x:auto;"><table class="dash-table"><thead><tr><th>Date</th><th>Plan</th><th>Amount</th><th>Status</th><th>Key</th><th>Ver</th><th>Last Active</th><th>Expiry</th><th>Action</th></tr></thead><tbody id="dashTableBody"></tbody></table></div>
            <div style="display:flex; justify-content:center; gap:10px; margin-top:20px;">
                <button id="prevBtn" onclick="changePage(-1)" class="nav-btn" style="background:gray; display:none;">Previous</button>
                <button id="nextBtn" onclick="changePage(1)" class="nav-btn" style="background:#2563EB; display:none;">Next</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="licenseModal" class="modal"><div class="modal-content" style="text-align:center;"><div style="font-size:3.5rem;">üéâ</div><h2 style="color:#059669;">Payment Successful!</h2><p>Download your license below.</p><div id="licenseKeyArea" class="key-box"></div><button class="btn-buy secondary" onclick="closeLicenseModal()">Close</button></div></div>

    <div id="bankModal" class="modal"><div class="modal-content"><span class="close-icon" onclick="document.getElementById('bankModal').style.display='none'">&times;</span><h2 style="text-align:center; margin-bottom:20px;">Update Banking Details</h2><form id="bankForm" class="login-form active" style="display:block;"><div class="form-group"><label>Bank Name</label><input type="text" name="bank_name" id="in_bank"></div><div class="form-group"><label>Account Holder Name</label><input type="text" name="account_holder" id="in_holder"></div><div class="form-group"><label>Account Number</label><input type="text" name="account_number" id="in_acct"></div><div class="form-group"><label>IFSC Code</label><input type="text" name="ifsc_code" id="in_ifsc"></div><div class="form-group"><label>UPI ID</label><input type="text" name="upi_id" id="in_upi"></div><button type="submit" class="btn-buy primary">Save Details</button></form></div></div>

    <!-- UPDATED REGISTER MODAL: PASSWORD DISABLED INITIALLY -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-icon" onclick="document.getElementById('registerModal').style.display='none'">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">Join as Partner</h2>
            <form id="regForm" onsubmit="return false;">
                <div class="form-group"><label>Full Name</label><input type="text" name="name" required></div>
                <div class="form-group"><label>Phone Number</label><input type="text" name="phone" required></div>
                
                <div class="form-group"><label>Email Address</label>
                    <div style="display:flex; gap:10px;">
                        <input type="email" name="email" id="regEmail" required style="flex:1; margin-bottom:0;">
                        <button type="button" onclick="sendRegOtp()" class="nav-btn" style="font-size:0.8rem; height:45px; margin-top:5px;">Get OTP</button>
                    </div>
                </div>
                
                <div id="otpInputSection" style="display:none; background:#F3F4F6; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <label>Enter Verification Code</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="regOtp" placeholder="6-Digit OTP" style="flex:1; margin-bottom:0; letter-spacing:3px; text-align:center;">
                        <button type="button" onclick="verifyRegOtp()" class="nav-btn" style="background:#059669; border-color:#059669; height:45px; margin-top:5px;">Verify</button>
                    </div>
                </div>
                
                <!-- PASSWORD FIELD DISABLED INITIALLY -->
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" id="regPass" required disabled placeholder="Verify OTP first to enable">
                </div>
                
                <button type="submit" id="finalRegBtn" class="btn-buy primary btn-disabled" disabled>Complete Registration</button>
            </form>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-icon" onclick="closeLoginModal()">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;">Portal Login</h2>
            <div class="login-tabs"><button class="tab-btn active" onclick="switchTab('distributor')">Distributor</button><button class="tab-btn" onclick="switchTab('admin')">Admin</button></div>
            <form id="distForm" class="login-form active"><div class="form-group"><label>Email</label><input type="email" name="email" required></div><div class="form-group"><label>Password</label><input type="password" name="password" required></div><div style="text-align:right;"><a onclick="showForgot()" style="color:blue; cursor:pointer; font-size:0.8rem;">Forgot Password?</a></div><button type="submit" class="btn-buy primary">Login</button></form>
            <div id="forgotFlow" style="display:none;"><div id="step1"><h3>Reset Password</h3><div class="form-group"><label>Enter Email</label><input type="email" id="resetEmail"></div><button onclick="sendOtp()" class="btn-buy primary">Send OTP</button></div><div id="step2" style="display:none;"><h3>Verify OTP</h3><div class="form-group"><label>Enter 6-digit Code</label><input type="text" id="otpCode"></div><div class="form-group"><label>New Password</label><input type="password" id="newPass"></div><button onclick="resetWithOtp()" class="btn-buy primary">Change Password</button></div><p style="text-align:center; margin-top:10px;"><a onclick="hideForgot()" style="cursor:pointer; color:gray;">Back</a></p></div>
            <form id="adminForm" class="login-form"><div class="form-group"><label>Username</label><input type="text" name="username" required></div><div class="form-group"><label>Password</label><input type="password" name="password" required></div><button type="submit" class="btn-buy primary" style="background:#111827;">Login Admin</button></form>
        </div>
    </div>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
        let RAZORPAY_KEY_ID = null;
        const BACKEND_URL = "https://zarqeen-backend.onrender.com";

        function toggleMobileMenu() { const nav = document.getElementById('mobileNav'); nav.classList.toggle('active'); }
        function checkDownload(e) { if (/Android|iPhone|iPad/i.test(navigator.userAgent)) { if(!confirm("‚ö†Ô∏è Warning: This software is for Windows PC only.\n\nIt will NOT work on mobile. Do you still want to download file to transfer to PC?")) { e.preventDefault(); } } }
        function showLoader(txt) { const loader = document.getElementById('actionLoader'); document.getElementById('loaderText').innerText = txt || "Loading..."; loader.style.display = 'flex'; setTimeout(() => { document.getElementById('loaderSubText').innerText = "Waking up server... please wait."; }, 3000); }
        function hideLoader() { document.getElementById('actionLoader').style.display = 'none'; }
        
        async function fetchConfig() { try { const res = await fetch(`${BACKEND_URL}/api/get-config`); const data = await res.json(); RAZORPAY_KEY_ID = data.key_id; } catch(e) { console.error(e); } }
        fetchConfig();

        function closeLicenseModal() { document.getElementById('licenseModal').style.display = 'none'; location.reload(); }
        function openLoginModal() { document.getElementById('loginModal').style.display = 'block'; }
        function openRegisterModal() { document.getElementById('registerModal').style.display = 'block'; }
        function closeLoginModal() { document.getElementById('loginModal').style.display = 'none'; }
        function openBankModal() { document.getElementById('bankModal').style.display = 'block'; }
        
        function switchTab(type) {
            document.getElementById('forgotFlow').style.display = 'none'; 
            if(type === 'distributor') { document.getElementById('distForm').style.display = 'block'; document.getElementById('distForm').classList.add('active'); document.getElementById('adminForm').classList.remove('active'); } 
            else { document.getElementById('distForm').style.display = 'none'; document.getElementById('distForm').classList.remove('active'); document.getElementById('adminForm').classList.add('active'); }
        }

        function showForgot() { document.getElementById('distForm').style.display = 'none'; document.getElementById('forgotFlow').style.display = 'block'; document.getElementById('step1').style.display = 'block'; document.getElementById('step2').style.display = 'none'; }
        function hideForgot() { document.getElementById('forgotFlow').style.display = 'none'; document.getElementById('distForm').style.display = 'block'; }

        async function sendOtp() {
            const email = document.getElementById('resetEmail').value; if(!email) return alert("Enter email"); showLoader("Sending OTP...");
            try { const res = await fetch(`${BACKEND_URL}/api/send-otp`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email}) }); const d = await res.json(); hideLoader(); if(d.success) { alert(d.message); document.getElementById('step1').style.display='none'; document.getElementById('step2').style.display='block'; } else alert(d.message); } catch(e) { hideLoader(); alert("Error sending OTP"); }
        }
        async function resetWithOtp() {
            const email = document.getElementById('resetEmail').value; const otp = document.getElementById('otpCode').value; const pw = document.getElementById('newPass').value;
            if(!otp || !pw) return alert("Fill all fields"); showLoader("Resetting...");
            try { const res = await fetch(`${BACKEND_URL}/api/reset-with-otp`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, otp, new_password:pw}) }); const d = await res.json(); hideLoader(); if(d.success) { alert(d.message); hideForgot(); } else alert(d.message); } catch(e) { hideLoader(); alert("Error resetting"); }
        }

        let regDataTemp = {}; 
        async function sendRegOtp() {
            const form = document.getElementById('regForm'); 
            const name = form.querySelector('[name="name"]').value.trim();
            const phone = form.querySelector('[name="phone"]').value.trim();
            const email = form.querySelector('[name="email"]').value.trim();
            
            // 1. Better Validation Popup
            if(!name || !email || !phone) {
                return alert("‚ö†Ô∏è Please enter your Name, Phone, and Email to receive the OTP.");
            }
            
            // Generate Dummy Password
            const dummyPass = "TEMP_" + Date.now();
            const data = { name, phone, email, password: dummyPass };
            regDataTemp = data; 
            
            showLoader("Sending Code...");
            
            try { 
                const res = await fetch(`${BACKEND_URL}/api/distributor/register`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(data) 
                }); 
                const r = await res.json(); 
                hideLoader(); 
                
                if(r.success) { 
                    // 2. Success Popup (Now uses message from backend)
                    alert("‚úÖ " + (r.message || "OTP Sent!")); 
                    document.getElementById('otpInputSection').style.display = 'block'; 
                    // Optional: Focus the OTP box
                    document.getElementById('regOtp').focus();
                } else { 
                    // 3. Error Popup
                    alert("‚ùå " + (r.message || "Failed to send OTP.")); 
                } 
            } catch(e) { 
                hideLoader(); 
                alert("‚ùå Connection Error. Please check your internet."); 
            }
        }

        async function verifyRegOtp() {
            const otp = document.getElementById('regOtp').value; 
            if(!otp) return alert("Enter Code");
            showLoader("Verifying...");
            
            try { 
                const res = await fetch(`${BACKEND_URL}/api/distributor/verify-registration`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: regDataTemp.email, otp: otp }) }); 
                const r = await res.json(); 
                hideLoader();
                
                if(r.success) { 
                    alert("Email Verified! Please set your password now.");
                    
                    // 1. Enable Password Input
                    const passInput = document.getElementById('regPass');
                    passInput.disabled = false;
                    passInput.placeholder = "Enter your desired password";
                    passInput.focus();
                    
                    // 2. Enable Complete Registration Button
                    const finalBtn = document.getElementById('finalRegBtn');
                    finalBtn.disabled = false;
                    finalBtn.classList.remove('btn-disabled');
                    
                    // 3. Store OTP to use it for password setting
                    regDataTemp.otp = otp;
                    regDataTemp.code = r.code;
                    
                    // 4. Hide OTP section to clean up UI (Optional)
                    document.getElementById('otpInputSection').style.display = 'none';
                    
                } else { 
                     alert(r.message); 
                } 
            } catch(e) { 
                hideLoader(); alert("Verification Failed"); 
            }
        }
        
        // REPLACED FINAL REGISTRATION LOGIC
        document.getElementById('finalRegBtn').addEventListener('click', async function(e) { 
            e.preventDefault(); 
            const realPassword = document.getElementById('regPass').value;
            if(!realPassword) return alert("Please enter a password.");

            showLoader("Setting Password...");

            try {
                // Call reset-with-otp to update the dummy password to the real one
                // This works because we removed the OTP clearing from verify_registration in backend
                const resetRes = await fetch(`${BACKEND_URL}/api/reset-with-otp`, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({ email: regDataTemp.email, otp: regDataTemp.otp, new_password: realPassword }) 
                });
                const resetJson = await resetRes.json();

                if(resetJson.success) {
                    // Password set successfully, now Login
                    const loginRes = await fetch(`${BACKEND_URL}/api/distributor/login`, { 
                        method: 'POST', 
                        headers: {'Content-Type': 'application/json'}, 
                        body: JSON.stringify({ email: regDataTemp.email, password: realPassword }) 
                    });
                    const loginJson = await loginRes.json();
                    hideLoader();
                    
                    if(loginJson.success) {
                         localStorage.setItem('dist_token', loginJson.token); 
                         document.getElementById('registerModal').style.display = 'none'; 
                         alert(`Registration Complete! Your Distributor Code is: ${regDataTemp.code}`); 
                         loadDashboard(1);
                    } else {
                        alert("Registration complete. Please login manually.");
                        document.getElementById('registerModal').style.display = 'none'; 
                        openLoginModal();
                    }
                } else {
                    hideLoader();
                    alert("Error setting password. Please use Forgot Password.");
                }
            } catch(e) {
                hideLoader();
                alert("Connection Error");
            }
        });

        document.getElementById('bankForm').addEventListener('submit', async function(e) {
            e.preventDefault(); showLoader("Updating..."); const token = localStorage.getItem('dist_token'); const data = Object.fromEntries(new FormData(this));
            try { const res = await fetch(`${BACKEND_URL}/api/distributor/update-bank`, { method: 'POST', headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}, body: JSON.stringify(data) }); const r = await res.json(); hideLoader(); if(r.success) { alert("Updated!"); document.getElementById('bankModal').style.display='none'; loadDashboard(1); } } catch(e) { hideLoader(); alert("Update Failed"); }
        });

        let ACTIVE_DISTRIBUTOR_CODE_BUY = null;
        async function applyCode() {
            const code = document.getElementById('distCode').value.trim(); if(!code) return; showLoader("Checking Code...");
            try { const res = await fetch(`${BACKEND_URL}/api/check_distributor`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ code }) }); const data = await res.json(); hideLoader();
            if (data.valid) { ACTIVE_DISTRIBUTOR_CODE_BUY = code; document.getElementById('codeMsg').innerText = `‚úÖ ${data.name} applied (${data.discount}% OFF)`; document.getElementById('codeMsg').style.color='green'; } else { ACTIVE_DISTRIBUTOR_CODE_BUY = null; document.getElementById('codeMsg').innerText="‚ùå Invalid Code"; document.getElementById('codeMsg').style.color='red'; } } catch(e) { hideLoader(); }
        }

        async function buyPlan(planType) {
            showLoader("Starting Payment..."); if (!RAZORPAY_KEY_ID) await fetchConfig();
            try {
                const res = await fetch(`${BACKEND_URL}/create_order`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ plan: planType, distributor_code: ACTIVE_DISTRIBUTOR_CODE_BUY }) });
                const orderData = await res.json(); hideLoader();
                const options = { "key": RAZORPAY_KEY_ID, "amount": orderData.amount, "currency": "INR", "name": "Zarqeen Alif", "handler": async function (response){ showLoader("Verifying..."); try { const verifyRes = await fetch(`${BACKEND_URL}/verify_payment`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ razorpay_payment_id: response.razorpay_payment_id, razorpay_order_id: response.razorpay_order_id, razorpay_signature: response.razorpay_signature, plan_type: planType }) }); const result = await verifyRes.json(); hideLoader(); if(result.success) { const blob = new Blob([result.license_key], { type: "text/plain" }); const url = window.URL.createObjectURL(blob); document.getElementById('licenseKeyArea').innerHTML = `<a href="${url}" download="license.zarqeen" class="btn-buy primary" style="text-decoration:none;">‚¨á Download License File</a>`; document.getElementById('licenseModal').style.display='block'; } else alert('Verification failed. Contact support.'); } catch (e) { hideLoader(); alert("Verification error."); } }, "modal": { "ondismiss": function(){ hideLoader(); } } };
                new Razorpay(options).open();
            } catch(e) { hideLoader(); alert("Connection Error"); }
        }

        document.getElementById('distForm').addEventListener('submit', async function(e) {
            e.preventDefault(); showLoader("Logging in..."); const data = Object.fromEntries(new FormData(this));
            try { const res = await fetch(`${BACKEND_URL}/api/distributor/login`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) }); const r = await res.json(); hideLoader(); if(r.success) { localStorage.setItem('dist_token', r.token); closeLoginModal(); loadDashboard(1); } else alert(r.message || "Failed"); } catch(e) { hideLoader(); alert("Error connecting"); }
        });

        // ADMIN LOGIN HANDLER
document.getElementById('adminForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    showLoader("Verifying Admin...");
    const data = Object.fromEntries(new FormData(this));
    try {
        const res = await fetch(`${BACKEND_URL}/admin/login`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
            credentials: 'include'  // <--- THIS LINE IS CRITICAL
        });
        const result = await res.json();
        hideLoader();
        if(result.success) {
            // Success! Redirect to dashboard
            window.location.href = result.redirect || `${BACKEND_URL}/admin/dashboard`;
        } else {
            alert(result.message || "Invalid Credentials");
        }
    } catch(e) {
        hideLoader();
        console.error(e);
        alert("Connection Error");
    }
});

        let CURRENT_PAGE = 1;
        async function loadDashboard(page) {
            CURRENT_PAGE = page; const token = localStorage.getItem('dist_token'); if(!token) return; showLoader("Loading Dashboard...");
            try {
                const res = await fetch(`${BACKEND_URL}/api/distributor/data?page=${page}`, { method: 'GET', headers: {'Authorization': `Bearer ${token}`} });
                if(res.status === 401) { doLogout(); return; }
                const data = await res.json();
                document.getElementById('dashName').innerText = data.name; document.getElementById('dashCode').innerText = data.code;
                const p = data.progress; if(p) { document.getElementById('lvlName').innerText = p.current_level; document.getElementById('lvlDisc').innerText = `${data.discount}% OFF`; if (p.is_max) { document.getElementById('lvlMsg').innerText = "Max Level Reached! üèÜ"; document.getElementById('lvlBar').style.width = "100%"; document.getElementById('lvlBar').style.background = "#10B981"; } else { const percent = Math.min((p.month_sales / p.target) * 100, 100); document.getElementById('lvlMsg').innerText = `${p.month_sales} / ${p.target} Sales to ${p.next_level}`; document.getElementById('lvlBar').style.width = `${percent}%`; } }
                document.getElementById('dashTotal').innerText = data.total_sales; document.getElementById('dashComm').innerHTML = `<span style="color:#2563EB">Earned: ‚Çπ${Number(data.commission_earned).toFixed(2)}</span><br><span style="color:#059669;font-size:0.8em">Paid: ‚Çπ${Number(data.commission_paid).toFixed(2)}</span><br><span style="color:#DC2626;font-size:0.9em;font-weight:800">Balance: ‚Çπ${Number(data.balance_due).toFixed(2)}</span>`; 
                const b = data.bank_info; document.getElementById('in_bank').value = b.bank_name||''; document.getElementById('in_holder').value = b.account_holder||''; document.getElementById('in_acct').value = b.account_number||''; document.getElementById('in_ifsc').value = b.ifsc||''; document.getElementById('in_upi').value = b.upi||'';
                document.getElementById('d_bank').innerText = b.bank_name||'-'; document.getElementById('d_holder').innerText = b.account_holder||'-'; document.getElementById('d_acct').innerText = b.account_number||'-'; document.getElementById('d_ifsc').innerText = b.ifsc||'-'; document.getElementById('d_upi').innerText = b.upi||'-';
                const tbody = document.getElementById('dashTableBody'); tbody.innerHTML = "";
                data.sales_history.forEach(row => { tbody.innerHTML += `<tr><td>${row.date}</td><td>${row.plan}</td><td>‚Çπ${row.amount}</td><td>${row.status}</td><td style="font-family:monospace">${row.key}</td><td>${row.version||'-'}</td><td>${row.last_login||'-'}</td><td>${row.expiry||'-'}</td><td><a href="${data.backend_url}download/license/${row.key}" class="nav-btn" style="padding:4px 8px;font-size:0.8rem;">‚¨á</a></td></tr>`; });
                const prev = document.getElementById('prevBtn'); const next = document.getElementById('nextBtn'); document.getElementById('pageInfo').innerText = `Page ${page} of ${data.pagination.total_pages}`; prev.style.display = data.pagination.has_prev ? 'inline-block' : 'none'; next.style.display = data.pagination.has_next ? 'inline-block' : 'none';
                document.querySelector('header').style.display='none'; document.querySelector('.hero').style.display='none'; document.getElementById('features').style.display='none'; document.getElementById('pricing').style.display='none'; document.querySelector('footer').style.display='none'; document.getElementById('dashboardSection').style.display='block'; hideLoader(); window.scrollTo(0,0);
            } catch(e) { hideLoader(); }
        }
        function changePage(dir) { loadDashboard(CURRENT_PAGE + dir); }
        function doLogout() { localStorage.removeItem('dist_token'); location.reload(); }
        window.addEventListener('load', function() { if(localStorage.getItem('dist_token')) loadDashboard(1); });
    </script>
</body>
</html>
